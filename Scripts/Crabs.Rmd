---
output: html_document
editor_options: 
  chunk_output_type: console
---
# Chance's Second Thesis Chapter: Understand Thermal Niche from Consumption TPCs

Made by Chance Yan Last Edit:

**Question:** Is there thermal niche overlap or complementary in consumption among the predatory crabs of the Gulf of Maine?

**Hypothesis:** There is thermal niche complementary between the crab predators. 

**Null Hypothesis:** There is thermal niche overlap between the crab predators.

**Predictions:**

-   Prediction 1: The asian shore crab will have the highest consumption TPC/thermal niche compared to green crabs and cancer crabs. Followed by green crabs having the second highest TPC/thermal niche. Meanwhile, cancer crabs (*Cancer borealis* preferred, but *Cancer irroratus* backup - more on this later)

-   Prediction 2:There is no difference in consumption TPC between green crabs, asian shore crabs, and cancer crabs. 

-   Prediction 3: There is some overlap between 2 of the species, but not the last one. 

**Experimental Design:**

2 Systems (2 possible temperatures at a time), 5 temperature regimes (minimum to map out a TPC), 3 species, 6 repetitions. We can only fit 18 individuals in each system.

6 reps \* 3 species \* 5 temperature regimes \* 2 temporal blocks = 180 crabs\

**Methods**

Crabs were collected and brought into GMS via SCUBA, intertidally, or trapping. Only males with 2 or less missing legs were used in the study. Upon entry into the lab, crabs were weight and carapace length was measured.
Crabs were placed into 5 gallon buckets in a wet table with a recirculating seawater system. Each were supplied with a water line and air line. There were two wet tables for one system which was set to one temperature treatment. The temperature treatments were
18, 20, 22, 24, and 26 degrees celcius.

Crabs were fed 3 times a week with clam and squid in an alternating pattern. Crabs were acclimated for the trial temperature for two weeks and fed an additional 3 times for the feeding trial.

## Data Processing

```{R, include = FALSE, warning = FALSE}
library(ggplot2)
library(lubridate)
library(hms)
library(dplyr)
library(emmeans)
library(knitr)
library(brglm)
setwd("/Users/chanceyan/Documents/R/ThesisCrab/Data")
crabdata <- read.csv("Feeding.csv", h=T, stringsAsFactors = FALSE)
death <- read.csv("DeathCount.csv", h=T, stringsAsFactors = FALSE)
master <- read.csv("Master.csv", h=T, stringsAsFactors = FALSE)
deathMeta <- read.csv("Death.csv", h=T, stringsAsFactors = FALSE)
husbandry <- read.csv("Husbandry.csv", h=T, stringsAsFactors = FALSE)
checkout <- read.csv("CheckOut.csv", h=T, stringsAsFactors = FALSE)
```

#### Cleaning up data for use

We need to clean up the data first to use it. What I did...

NOTE: "feeding points" refer to a measurement of feeding. Therefore we have multiple feeding points from a single individual crab. 

-   Removed feeding points that used mussels and mackerel. We fed two days total of mussels and mackerel to find out that it was too difficult to measure accurately. Afterwards, we switched to Clam and Squid in an alternating pattern
-   I then removed those who molted (removed as in removed all feeding points that individual contributed to the dataset) as molting has been shown in the literature to affect feeding rate.
-   I removed the first week and first period of feeding from Trial 18 and 22 since they were fed two days in a row (accidentally + understanding methods). They still had 3 weeks of feeding (2 weeks of acclimation similar to the other trials).
-   I removed feeding points for those who ate everything that we fed them. This is because it's possible they could have eaten more and the point becomes inaccurate. 
-   Very rarely (around 4-5 times total), food would be found floating in the bucket after waiting the feeding period. I have removed these feeding points as well because the crab couldn't get to the food and eat for the feeding period and therefore the point cannot be trusted
-   The rest of the code is marking individuals if they've eaten or not, still eaten, making extra variables so that further analyses are easier.

```{R include = FALSE, warning = FALSE}
#removing rows that contain no data or recorded incorrectly
for(i in 1:nrow(crabdata)){
  if(!is.numeric(crabdata[i,4])){
    print(crabdata[i])
    crabdata <- crabdata[-i,]
  }
  if(!is.numeric(crabdata[i,6])){
    print(crabdata[i])
    crabdata <- crabdata[-i,]
  }
}

#Creating number IDs for each crab based of their IDs so it's easier to loop through with future code. Also I'm adding a total eaten by proportion column, so we have a standard metric to compare by.
for(i in 1:36){
  master$num[[i]] <- substr(master$ID[[i]], 3,5)
}

crabdata$amount.eaten <- crabdata$FoodIn-crabdata$FoodOut
all <- merge(crabdata, master, by="ID")

#renaming temperature.x to temperature
all <- all %>% select(-Temperature.y)
names(all)[names(all) == "Temperature.x"] <- "Temperature"

#Changing date column into a date data type, so that R can read it as a Date.
all$Date.x = as.Date(all$Date.x, format = "%m/%d/%Y")
deathMeta$Date = as.Date(deathMeta$Date, format = "%m/%d/%Y")

#removing mussel and mackerel feed
all <- subset(all, all$Food != "Mussels")
all <- subset(all, all$Food != "Mackerel")


#saving those who molted in an original dataset
original_molted <- all
original_molted$molted <- ifelse(grepl("ME", original_molted$Notes.x, fixed = TRUE), "YES", "NO")

#Removing those that molted
array <- c()

for(i in 1:nrow(all)){
  if(grepl("ME", all$Notes.x[i], fixed = TRUE)){
    ID_value <- all$ID[i]
    for(j in 1:nrow(all)){
      if(all$ID[j] == ID_value){
        array <- c(array, j)
      }
    }
  }
}

all <- all[-array,]
array <- c()

#Removing these dates because feeding was not following a strict schedule (fed two days back to back)
all <- subset(all, !(WeekNum == 1 & Temperature == 16))
all <- subset(all, !(WeekNum == 1 & Temperature == 22 & Period == 1))

#Changing trials 16 and 18 to be one.
original <- all
all$Temperature <- ifelse(all$Temperature == 16, 18, all$Temperature)
original$Temperature <- ifelse(original$Temperature == 16, 18, original$Temperature)
master$Temperature <- ifelse(master$Temperature == 16, 18, master$Temperature)

#Here, I am marking all those who did not eat
EatDF <- subset(all, grepl("DE", all$Notes.x, fixed = TRUE))

#removing all those who ate everything
all <- all[ !grepl("AE", all$Notes.x), ]

#removing all those who were found to have floating food
all <- all[ !grepl("FLOAT", all$Notes.x), ]

#Making a new column indicating whether the animal ate or not
eaten_row <- list()
for(i in 1:nrow(all)){
  if(grepl("DE", all$Notes.x[i], fixed = TRUE)){
    eaten_row <- c(eaten_row, "NO")
  }
  else{
    eaten_row <- c(eaten_row, "YES")
  }
}
all$eaten <- eaten_row

#Making a column if the animal was still eating or not
all$still_eating <- ifelse(grepl("SE", all$Notes.x, fixed = TRUE), "YES", "NO")

inBucket <- list()
#total time of food in bucket
all$TimeInStrip <- as.POSIXct(paste(all$Date.x, all$TimeIn), format = "%Y-%m-%d %I:%M:%S %p")
all$TimeOutStrip <- as.POSIXct(paste(all$Date.x, all$TimeOut), format = "%Y-%m-%d %I:%M:%S %p")

#because we removed the first week from trials 1 and 2, to get the final week, I'll just subtract one from the value to line it up so that week 4 equals week 3 and make it easier for me to graph

all$WeekNum <- ifelse((all$Temperature == 18 & all$WeekNum == 2 & all$Period == 1), 1, all$WeekNum)
all$WeekNum <- ifelse((all$Temperature == 18 & all$WeekNum == 3 & all$Period == 1), 2, all$WeekNum)
all$WeekNum <- ifelse((all$Temperature == 18 & all$WeekNum == 4 & all$Period == 1), 3, all$WeekNum)

all$WeekNum <- ifelse((all$Temperature == 22 & all$WeekNum == 2 & all$Period == 1), 1, all$WeekNum)
all$WeekNum <- ifelse((all$Temperature == 22 & all$WeekNum == 3 & all$Period == 1), 2, all$WeekNum)
all$WeekNum <- ifelse((all$Temperature == 22 & all$WeekNum == 4 & all$Period == 1), 3, all$WeekNum)

#making a new ID for those that are placements
all$ID <- ifelse(grepl("RE", all$Notes.x), paste(all$ID, "R"), all$ID)

#husbandry sheet prep
husbandry <- subset(husbandry, husbandry$Trial != "NONE")
```

We have some decisions to make, but we'll boil it down to the all-inclusive model vs the censoring model

All-inclusive model: 
-Add in all those who died as zeros and even beyond after they died they still remain as 0's. 
-Also keep in replacement data.
-Keep crabs who died as is in the data set

Censoring model: 
-Remove feeding points from all those who died and those who were replacement.
-Turn all the feeding points of those who did not eat to 0
-Remove dead individual

ALL-INCLUSIVE MODEL:
-Includes all those who died, data points after they've died becomes 0
-Incudes those that were replaced as well
```{R}
inclusive <- all

inclusive$proportion.eaten <- inclusive$amount.eaten / inclusive$WW
inclusive <- subset(inclusive, !is.na(inclusive$proportion.eaten))
```

CENSORING MODEL:
-Removes those who died completely and those who were used to be replaced. 
-Sets those who didn't eat to 0 (for feeding points)
```{R}
censor <- all

censor$amount.eaten <- ifelse(grepl("DE", censor$Notes.x, fixed = TRUE), 0, censor$amount.eaten)
censor$amount.eaten <- ifelse(censor$amount.eaten < 0, 0, censor$amount.eaten)

censor <- censor[is.na(censor$Date.x) | !(censor$ID %in% deathMeta$ID),]


censor <- censor %>% filter(!grepl("DI", Notes.x))
censor <- censor %>% filter(!grepl("ADDI", Notes.x))
censor <- censor %>% filter(!grepl("RE", Notes.x))

censor$proportion.eaten <- censor$amount.eaten / censor$WW
censor <- subset(censor, !is.na(censor$proportion.eaten))
```

## Data Exploration

### Basic information on the dataset (Post Data Modifications)

```{r echo = FALSE, warning = FALSE}
#inclusive model
a <- tapply(inclusive$ID, list(inclusive$Species.x, inclusive$Temperature), FUN = function(x) length(unique(x)))
b <- tapply(inclusive$proportion.eaten, list(inclusive$Species.x, inclusive$Temperature), FUN = length)

#censor model
d <- tapply(censor$ID, list(censor$Species.x, censor$Temperature), FUN = function(x) length(unique(x)))
e <- tapply(censor$proportion.eaten, list(censor$Species.x, censor$Temperature), FUN = length)

kable(rbind(Inclusive = a, Censor = d), caption = "Inclusive on top, Censor on the bottom. Number of Individuals")
kable(rbind(Inclusive = b, Censor = e), caption = "Inclusive on top, Censor on the bottom. Number of Feeding Points")
```

### Death OR Alive

What I did:
-I added the extras om the master dataframe which contains all individuals who were ever in the systems that are included in the project
-I then created two exploratory graphs to represent how the data looks in general - NOTE - a good model should show that there is an DECREASe in alive individuals as temperature increases for the Rock Crab. Greeb crabs and shore crabs should remain relatively flat (no increase death with temperatures)
-To account for the separated data I will use a bias reduced GLM. Following code from: https://bscheng.com/2016/12/11/modeling-completely-separated-data-in-r/
-I then fit the model to an all mod (all explanatory variables added with interactions). Then dredged the model to see which model is the "best"
-The best model came back as one that included temperature and Species (all explanatory variables); however, without interactions
-Best model <- dead ~ Temperature(numeric) + Species
-This best model summary tells us there are differences in the INTERCEPTS between green crabs/shore crabs and rock crabs. The model also indicates that there is a slope that is negative for ALL species. This is because we did not include an interaction (including an interaction makes the model find no differences and AIC finds no interaction model a worse one)
-Since it seems obvious that rock crabs are doing worse than green crabs and shore crabs (a little disappointed it didn't pick it up), I modeled with just rock crab data
-I modeled just rock crab data and found that there was a signficantly negative slope as temperature increases.

Summary: I modeled dead and alive crabs using a bias reduced GLM. After dredging the best model was a full addivite model (temperature and species); however, the model dictataes all species have the same slope (decrease of alive individuals across temperature) and therefore I modeled just rock crabs to see a negative slope (decrease in alive individuals)

```{R}
#parsing between those who died during the experiment and those who lived
master$dead <- ifelse(master$ID %in% deathMeta$ID, 0, 1)	

#changing name from Trial to Temperature to avoid confusion
names(master)[names(master) == "Trial"] <- "Temperature"

#addition of extras
{
add_rows <- data.frame(ID = "extra1_26", System = NA, CL = NA, WW = NA, Temperature = 26, Species = "Irroratus", Condition = NA, Period = NA, Date = NA, Notes = NA, num = NA, dead = 0)
master <- rbind(master, add_rows)
add_rows <- data.frame(ID = "extra2_26", System = NA, CL = NA, WW = NA, Temperature = 26, Species = "Irroratus", Condition = NA, Period = NA, Date = NA, Notes = NA, num = NA, dead = 0)
master <- rbind(master, add_rows)
add_rows <- data.frame(ID = "extra1_24", System = NA, CL = NA, WW = NA, Temperature = 24, Species = "Irroratus", Condition = NA, Period = NA, Date = NA, Notes = NA, num = NA, dead = 0)
master <- rbind(master, add_rows)
add_rows <- data.frame(ID = "extra2_24", System = NA, CL = NA, WW = NA, Temperature = 24, Species = "Irroratus", Condition = NA, Period = NA, Date = NA, Notes = NA, num = NA, dead = 1)
master <- rbind(master, add_rows)
add_rows <- data.frame(ID = "extra1_22", System = NA, CL = NA, WW = NA, Temperature = 22, Species = "Irroratus", Condition = NA, Period = NA, Date = NA, Notes = NA, num = NA, dead = 1)
master <- rbind(master, add_rows)
add_rows <- data.frame(ID = "extra2_22", System = NA, CL = NA, WW = NA, Temperature = 22, Species = "Irroratus", Condition = NA, Period = NA, Date = NA, Notes = NA, num = NA, dead = 1)
master <- rbind(master, add_rows)
add_rows <- data.frame(ID = "extra1_20", System = NA, CL = NA, WW = NA, Temperature = 20, Species = "Irroratus", Condition = NA, Period = NA, Date = NA, Notes = NA, num = NA, dead = 1)
master <- rbind(master, add_rows)
add_rows <- data.frame(ID = "extra2_20", System = NA, CL = NA, WW = NA, Temperature = 20, Species = "Irroratus", Condition = NA, Period = NA, Date = NA, Notes = NA, num = NA, dead = 1)
master <- rbind(master, add_rows)
add_rows <- data.frame(ID = "extra1_18", System = NA, CL = NA, WW = NA, Temperature = 18, Species = "Irroratus", Condition = NA, Period = NA, Date = NA, Notes = NA, num = NA, dead = 1)
master <- rbind(master, add_rows)
add_rows <- data.frame(ID = "extra2_18", System = NA, CL = NA, WW = NA, Temperature = 18, Species = "Irroratus", Condition = NA, Period = NA, Date = NA, Notes = NA, num = NA, dead = 1)
master <- rbind(master, add_rows)
}

mastergraph <-  master %>%
  count(Species, Temperature, dead) %>%
  group_by(Species, Temperature) %>%
  mutate(
    proportion = n / sum(n)
  )

mastergraph$dead <- factor(mastergraph$dead, levels = c(1,0))

ggplot(mastergraph, aes(x = Temperature, y = proportion, fill = dead)) + geom_col() + facet_wrap(~Species)+
  scale_fill_manual(values = c("0" = "darkred", "1" = "darkgreen")) + ggtitle("Proportion of crab deaths across temperature")

mastergraph <- master
mastergraph$dead <- factor(mastergraph$dead, levels = c(0,1))

ggplot(mastergraph, aes(x = Temperature, y = dead, color = dead)) + geom_point(position = position_jitter(width = 0.005)) +
  geom_smooth(aes(group = 1), method = "loess", se = FALSE) +
  xlab("Temperature")+
  ylab("Count")+
  facet_wrap(~Species)+
  ggtitle("The counts of dead vs alive individuals in each trial for each species")+
  scale_color_manual(values = c("0" = "darkred", "1" = "darkgreen"))

#using 
all.mod <- brglm(dead ~ Temperature*Species, family = binomial, data = master, na.action = "na.fail")
dredge(all.mod, rank = "AICc")

#the best mod is inclusion of Species and Trial with no interaction
best.mod <- brglm(dead ~ Temperature + Species, family = binomial, data = master, na.action = "na.fail")
summary(best.mod)
#what's the best way to create diagnostic plots for this?

master$Species <- factor(master$Species)
newdat <- expand.grid(Temperature = seq(min(master$Temperature), max(master$Temperature), length.out = 100), Species = levels(master$Species))
newdat$Species <- factor(newdat$Species, levels = levels(master$Species))

newdat$pred <- predict(best.mod, newdata = newdat, type = "response")

ggplot(master, aes(x = Temperature, y = dead, color = Species)) +
  geom_point(position = position_jitter(height = 0.05), alpha = 0.6) +
  geom_line(data = newdat, aes(x = Temperature, y = pred, color = Species), linewidth = 1) +
  scale_y_continuous(limits = c(0, 1)) + 
  ggtitle("The number of dead (0) vs alive (1) crabs across 5 different temperatures") + 
  scale_color_manual(values = c("Carcinus" = "darkgreen",
                                "Hemigrapsus" = "darkred",
                                "Irroratus" = "darkorange"))

#just Cancer Irroratus
holddf <- subset(master, master$Species == "Irroratus")
all.mod <- brglm(dead ~ Temperature, family = binomial, data = holddf, na.action = "na.fail")
dredge(all.mod, rank = "AICc")
best.mod <- brglm(dead ~ Temperature, family = binomial, data = holddf, na.action = "na.fail")
summary(best.mod)

newdat <- data.frame(Temperature = seq(min(holddf$Temperature), max(holddf$Temperature), length.out = 100))

newdat$pred <- predict(best.mod, newdata = newdat, type = "response")

ggplot(holddf, aes(x = Temperature, y = dead)) +
  geom_point(position = position_jitter(height = 0.05), alpha = 0.6) +
  geom_line(data = newdat, aes(x = Temperature, y = pred), color = "darkorange", linewidth = 1) +
  scale_y_continuous(limits = c(0, 1)) + 
  ggtitle("The number of dead (0) vs alive (1) Atlantic rock crabs across 5 different temperatures")
```

### Acclimation

-I started by graphing what we would expect the acclimation models to suggest.
-If acclimation worked, we should expect an increase or decrease in the first week to the second then it should hit a flat line (indicating no change in consumption) going from week 2 to 3. That would indicate 2 weeks of acclimation is sufficient for measuring consumption
-I summarized the mean and standard error for each species, temperature and period then graphed the proportion consumed over week number to test if the acclimation worked. I also compared these graphs between the censor model and inclusive model
-I found very little differences (visually) between the inclusive and censor model
-Off to modeling!

```{R echo = FALSE, warning = FALSE}
summary_inclusive <- inclusive %>%
  group_by(Species.x, Temperature, Period, WeekNum) %>%
  summarise(
    mean = mean(proportion.eaten),
    se = sd(proportion.eaten) / sqrt(n())
  )

summary_inclusive$SpeciesPeriod <- paste(summary_inclusive$Species.x, summary_inclusive$Period, sep = "_")

summary_censor <- censor %>%
  group_by(Species.x, Temperature, Period, WeekNum) %>%
  summarise(
    mean = mean(proportion.eaten),
    se = sd(proportion.eaten) / sqrt(n())
  )

summary_censor$SpeciesPeriod <- paste(summary_censor$Species.x, summary_censor$Period, sep = "_")

#INCLUSIVE MODEL
ggplot(summary_inclusive, aes(x = as.numeric(WeekNum), y = mean, color = SpeciesPeriod)) + 
  geom_point(position = position_dodge(width = 0.2)) + 
  facet_wrap(~as.factor(Temperature)) +
  ggtitle("Proportion consumed over week number for the inclusive model") + 
  geom_smooth(method = "loess", se = FALSE)+
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), position = position_dodge(width = 0.2))+
  scale_color_manual(values = c("CI_1" = "darkorange3",
                     "CI_2" = "orange",
                     "CM_1" = "darkgreen",
                     "CM_2" = "green3",
                     "HS_1" = "darkred",
                     "HS_2" = "red3"))

#CENSOR MODEL
ggplot(summary_censor, aes(x = as.numeric(WeekNum), y = mean, color = SpeciesPeriod)) + 
  geom_point(position = position_dodge(width = 0.2)) + 
  facet_wrap(~as.factor(Temperature)) +
  ggtitle("Proportion consumed over week number for the censor model") + 
  geom_smooth(method = "loess", se = FALSE)+
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), position = position_dodge(width = 0.2))+
  scale_color_manual(values = c("CI_1" = "darkorange3",
                     "CI_2" = "orange",
                     "CM_1" = "darkgreen",
                     "CM_2" = "green3",
                     "HS_1" = "darkred",
                     "HS_2" = "red3"))

#proportion eaten (our response variable) is right skewed, not normal violates assumption
hist(inclusive$proportion.eaten) #contains negative values
inclusive$sqrtproportion.eaten <- sqrt(inclusive$proportion.eaten + 1)
qqnorm(inclusive$proportion.eaten)
hist(inclusive$sqrtproportion.eaten)

hist(censor$proportion.eaten) #doesn't contain negative values

censor$proportion.eaten <- ifelse(censor$proportion.eaten == 0, .001, censor$proportion.eaten)
hist(censor$proportion.eaten)
all.mod <- glm(proportion.eaten ~ Species.x*Temperature*as.factor(Period), family = Gamma("inverse"), data = censor, na.action = "na.fail")
dredge(all.mod, rank = "AICc")

best.mod <- glm(proportion.eaten ~ as.factor(Period) + Species.x + Temperature + as.factor(Period)*Species.x + Species.x*Temperature, family = Gamma("inverse"), data = censor)
summary(best.mod)
plot(best.mod)

```

### Looking at the proportion eaten for each trial for each individual species (CI, CM, and HS)

```{R, echo=FALSE,results='hide',fig.keep='all'}
#only accounting for final week of trial
finalEat <- subset(all, all$WeekNum == 3)

summary_df <- finalEat %>%
  group_by(Species.x, Temperature, Period) %>%
  summarise(
    mean = mean(proportion.eaten),
    se = sd(proportion.eaten) / sqrt(n())
  )

ggplot(summary_df, aes(x = as.numeric(Temperature), y = mean, color = Species.x)) + geom_point(position = position_dodge(width = 0.3))+
  scale_color_manual(values = c("HS" = "darkred",
                                 "CM" = "darkgreen",
                                 "CI" = "darkorange"))+
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se),
                width = 0.1, size = 0.8, position = position_dodge(width = 0.3)) +
  geom_smooth(method = "loess", se = FALSE)+ scale_y_log10()+
  ylab("Logged Mean of Proportion Eaten")+
  xlab("Trial Temperature") + labs(color = "Species")+
  ggtitle("Proportion Consumed over Trial Temperature")

holddf <- subset(finalEat, finalEat$Species.x == "CI")
mod <- glm(holddf$proportion.eaten ~ as.factor(holddf$Temperature))
summary(mod)
emm <- emmeans(mod, ~ as.factor(Temperature))
pairs_data <- pairs(emm)
pairs_data

holddf <- subset(finalEat, finalEat$Species.x == "CM")
mod <- glm(holddf$proportion.eaten ~ as.factor(holddf$Temperature))
summary(mod)
emm <- emmeans(mod, ~ as.factor(Temperature))
pairs_data <- pairs(emm)
pairs_data

holddf <- subset(finalEat, finalEat$Species.x == "HS")
mod <- glm(holddf$proportion.eaten ~ as.factor(holddf$Temperature))
summary(mod)
emm <- emmeans(mod, ~ as.factor(Temperature))
pairs_data <- pairs(emm)
pairs_data
```



EXTRAS

#### Amount of who did not eat by species and trial

```{R, echo = FALSE, warning = FALSE}
all$eaten <- factor(all$eaten, levels = c("YES", "NO"))
all$Species.x <- factor(all$Species.x, levels = c("HS", "CM", "CI"))
ggplot(all, aes(x = Temperature, fill = eaten)) + geom_bar(stat = "count") + facet_wrap(~Species.x)+
  scale_fill_manual(values = c("YES" = "darkolivegreen4",
                                "NO"="darkred"))+ggtitle("Amount of Times Individuals did not eat")+xlab("Trial Temperature") + ylab("Count")

#Amount of those who are still eating vs not eating
all$still_eating <- factor(all$still_eating, leve = c("NO", "YES"))
ggplot(all, aes(x = Temperature, fill = still_eating))+ geom_bar(stat = "count") + facet_wrap(~Species.x)+
  ggtitle("Amount of those who are still eating vs not eating") +
  scale_fill_manual(values = c("YES" = "darkolivegreen4",
                                "NO"="darkred"))+xlab("Trial Temperature") + ylab("Count")
```

### Schedule

```{R echo = FALSE}
date_list <- data.frame(date = NA, trial = NA, period = NA)
date_list$date <- as.Date(date_list$date)
trial_list <- list("18", "20", "22", "24", "26")

for(a in 1:2){
  for(i in 1:length(trial_list)){
  holddf <- subset(original, original$Temperature == trial_list[i] & original$Period == a)
  dates <- unique(holddf$Date.x)
  for(j in 1:length(dates)){
    date_list[nrow(date_list) + 1,] <- list(dates[j], trial_list[i], a)
  }
}
}
date_list <- na.omit(date_list)

date_list$trial <- unlist(date_list$trial)
date_list$weekday <- weekdays(date_list$date)
date_list$month <- month(date_list$date)
date_list$day <- format(as.Date(date_list$date,format="%y-%m-%d"), format = "%d")

date_list$weekday <- as.factor(date_list$weekday)
date_list$month <- as.factor(date_list$month)
date_list$day <- as.factor(date_list$day)

date_list <- na.omit(date_list)
date_list$day <- as.numeric(as.character(date_list$day))  # "09" → 9
date_list$day <- factor(date_list$day, levels = 1:31)

ggplot(date_list, aes(x = day, y = as.factor(trial), fill = as.factor(period))) +
  geom_tile(color = "black",alpha = 0.5) +
  facet_wrap(~ month, ncol = 1) +
  coord_fixed() +
  scale_x_discrete(drop = FALSE)+
  ggtitle("Trial schedule for the Summer of 2025")+
  xlab("Day")+
  ylab("Trial Temperature")+ guides(fill=guide_legend(title="Period")) + theme_classic() +
  scale_fill_manual(values = c("1" = "red4",
                                "2"="blue4"))
```

## Outlier Search

```{r, fig.show="hold", out.width="50%", echo = FALSE, warning = FALSE}
ggplot(all, aes(y = CL, color = Species.x)) + geom_boxplot() +
  ggtitle("Species Comparison between Carapace Length")+
  scale_color_manual(values = c("CI" = "darkorange",
                                "CM"="darkgreen",
                                "HS"="darkred"))

ggplot(all, aes(y = proportion.eaten, color = Species.x)) + geom_boxplot() +
  ggtitle("Species Comparison Between Proportion Eaten")+
  scale_color_manual(values = c("CI" = "darkorange",
                                "CM"="darkgreen",
                                "HS"="darkred"))

# Carapace Length and Wet Weight Comparison between species

ggplot(master, aes(x = WW, y = CL, color = Species)) + geom_point()+
  ggtitle("Carapace Length and Wet Weight Comparison between species")+
  scale_color_manual(values = c("Irroratus" = "darkorange",
                                "Carcinus"="darkgreen",
                                "Hemigrapsus"="darkred"))


#There is an outlier who is CM 176 - I am willing to throw this individual out since he is the only one of it's kind
#all <- subset(all, all$ID != "CM176")
outliers <- list(c(ID = "CM176"))

#Pretty normal - looking good
# Checking for Outliers and that wet weight is normal
holddf <- subset(master, master$Species == "Irroratus")
ggplot(holddf, aes(x = WW)) + geom_histogram(binwidth = 25, fill = "darkorange", color = "black") + facet_wrap(~Species, scales = "free") + ggtitle("Wet weight for Cancer")

holddf <- subset(master, master$Species == "Carcinus")
ggplot(holddf, aes(x = WW)) + geom_histogram(binwidth = 15, fill = "darkgreen", color = "black") + facet_wrap(~Species, scales = "free") + ggtitle("Wet weight for Carcinus")

holddf <- subset(master, master$Species == "Hemigrapsus")
ggplot(holddf, aes(x = WW)) + geom_histogram(binwidth = 1, fill = "darkred", color = "black") + facet_wrap(~Species, scales = "free") + ggtitle("Wet weight for Hemigrapsus")

#We can check if there are differences in weight weight between Species and Trial through some quick models
holddf <- subset(master, master$Species == "Irroratus")
mod <- glm(holddf$WW ~ holddf$Trial * holddf$Period)
emm <- emmeans(mod, ~ Trial*Period)
pairs_data <- pairs(emm)
pairs_data

holddf <- subset(master, master$Species == "Carcinus")
mod <- glm(holddf$WW ~ holddf$Trial * holddf$Period)
emm <- emmeans(mod, ~ Trial*Period)
pairs_data <- pairs(emm)
pairs_data

holddf <- subset(master, master$Species == "Hemigrapsus")
mod <- glm(holddf$WW ~ holddf$Trial * holddf$Period)
emm <- emmeans(mod, ~ Trial*Period)
pairs_data <- pairs(emm)
pairs_data

#NO DIFFERENCE FOR SIZE BETWEEN TRIAL AND PERIOD FOR EACH SPECIES WOOOOOOOO

#Looking more specifically at each outlier for weight to see if they acted as expected or not. Checking in on the outlier for rock and hemi
#CI117
holddf <- subset(all, all$ID == "CI117")
ggplot(holddf, aes(x = Date.x, y = proportion.eaten)) + geom_point() + geom_smooth(method = "loess", se = FALSE) + ggtitle("Proportion eaten by CI117 in 18 C in period 2")

#HS92
holddf <- subset(all, all$ID == "HS92")
ggplot(holddf, aes(x = Date.x, y = proportion.eaten)) + geom_point() + geom_smooth(method = "loess", se = FALSE) + ggtitle("Proportion eaten by HS92 in 26 C in period 2")

#HS92
holddf <- subset(all, all$ID == "CM176")
ggplot(holddf, aes(x = Date.x, y = proportion.eaten)) + geom_point() + geom_smooth(method = "loess", se = FALSE) + ggtitle("Proportion eaten by CM176 in 20 C in period 2")

# Plotting the proportion eaten to see outliers and normality
ggplot(all, aes(x = proportion.eaten, fill = Species.x)) + geom_histogram(binwidth = 0.01) + facet_wrap(~Species.x, scales = "free") + ggtitle("Proportion eaten by species")+
  scale_fill_manual(values = c("CI" = "darkorange",
                                "CM"="darkgreen",
                                "HS"="darkred"))
#everyone looks normal except for hemigrapsus which has some trialing end points
```

### Size effect on Consumption

```{R echo = FALSE}
ggplot(all, aes(x = WW, y = proportion.eaten, color = Species.x)) + geom_point() +geom_smooth(aes(x = WW, y = proportion.eaten,group = Species.x),   
    color = "black",    
    se = FALSE,
    inherit.aes = FALSE,
    method = "lm")+  
  scale_x_log10() +
  scale_color_manual(values = c("CI" = "darkorange",
                                "CM"="darkgreen",
                                "HS"="darkred")) + ylab("Amount Eaten (proportionally)") +xlab("WW (log scale)") +ggtitle("Amount Eaten by Weight") + labs(color = "Species")
```

### Regraphing Hemi and Carcinus without those who didn't eat (prediction of molt)

```{R, echo=FALSE,results='hide',fig.keep='all'}
summary_df <- EatDF %>%
  group_by(Species.x, Temperature, Period, still_eating) %>%
  summarise(
    mean = mean(proportion.eaten),
    se = sd(proportion.eaten) / sqrt(n())
  )
summary_df <- subset(summary_df, summary_df$still_eating == "NO")

ggplot(summary_df, aes(x = as.numeric(Temperature), y = mean, color = Species.x)) + geom_point(position = position_dodge(width = 0.3))+
  scale_color_manual(values = c("HS" = "darkred",
                                 "CM" = "darkgreen",
                                 "CI" = "darkorange"))+
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se),
                width = 0.1, size = 0.8, position = position_dodge(width = 0.3)) +
  geom_smooth(method = "loess", se = FALSE)+ scale_y_log10()+
  ylab("Logged Mean of Proportion Eaten")+
  xlab("Trial Temperature") + labs(color = "Species")+
  ggtitle("Proportion Consumed over Trial Temperature")
```

### Graphing the Husbandry Logs

```{R, echo = FALSE, warning = FALSE}
savedhus <- husbandry
husbandry <- savedhus
husbandry$Date <- as.Date(husbandry$Date, format="%m/%d/%Y")
ggplot(husbandry, aes(x = Date, y = Temperature, color = Trial)) + geom_point() + facet_grid(Period~System)+
  scale_y_continuous(breaks = c(16, 18, 20, 22, 24, 26, 28))+ggtitle("Temperature Records for Each System and Trial") + 
  scale_color_manual(values = c("18"= "yellow",
                               "20" = "#fecc5c",
                               "22" = "#fd8d3c",
                               "24" ="#f03b20",
                               "26" = "#bd0026")) +theme_dark()
```

### Graphing Crab mass before and after the experiment

```{R, echo=FALSE,results='hide',fig.keep='all'}
ID_list <- list()
trial_list <- list()
period_list <- list()
species_list <- list()
weight_before <- list()
weight_after <- list()

for(i in 1:nrow(master)){
  if(master$ID[i] %in% deathMeta$ID){
    
  }
  else{
    ID_list <- append(ID_list, master$ID[i])
    trial_list <- append(trial_list, master$Trial[i])
    period_list <- append(period_list, master$Period[i])
    species_list <- append(species_list, master$Species[i])
    weight_before <- append(weight_before, master$WW[i])
    weight_after <- append(weight_after, checkout$WW[which(checkout$ID == master$ID[i])])
  }
}

weight_df <- data.frame(
  ID = unlist(I(ID_list)),
  Trial = unlist(I(trial_list)),
  Period = unlist(I(period_list)),
  species = unlist(I(species_list)),
  weight_before = unlist(I(weight_before)),
  weight_after = unlist(I(weight_after))
)

weight_df$dif <- as.numeric(weight_df$weight_after) - as.numeric(weight_df$weight_before)

#CM139
#CM141

weight_df <- subset(weight_df, weight_df$ID != "CM139")
weight_df <- subset(weight_df, weight_df$ID != "CM141")

ggplot(weight_df, aes(x = as.factor(species), y = as.numeric(dif), fill = species)) + geom_boxplot(na.rm = TRUE)+
  scale_fill_manual(values = c("Carcinus" = "darkgreen",
                               "Hemigrapsus" = "darkred",
                               "Irroratus" = "darkorange"))+
  geom_hline(yintercept = 0, color = "red", linetype = "dashed", size = 0.5) + ggtitle("Weight change of each species over the whole experiment")+
  facet_wrap(~Trial)+xlab("Species") + ylab("Weight Change (g)")
```