---
output: html_document
editor_options: 
  chunk_output_type: console
---
# Chance's Second Thesis Chapter: Understand Thermal Niche from Consumption TPCs

Made by Chance Yan Last Edit:

**Question:** Is there thermal niche overlap or complementary in consumption among the predatory crabs of the Gulf of Maine?

**Hypothesis:** There is thermal niche complementary between the crab predators. 

**Null Hypothesis:** There is thermal niche overlap between the crab predators.

**Predictions:**

-   Prediction 1: The asian shore crab will have the highest consumption TPC/thermal niche compared to green crabs and cancer crabs. Followed by green crabs having the second highest TPC/thermal niche. Meanwhile, cancer crabs (*Cancer borealis* preferred, but *Cancer irroratus* backup - more on this later)

-   Prediction 2:There is no difference in consumption TPC between green crabs, asian shore crabs, and cancer crabs. 

-   Prediction 3: There is some overlap between 2 of the species, but not the last one. 

**Experimental Design:**

2 Systems (2 possible temperatures at a time), 5 temperature regimes (minimum to map out a TPC), 3 species, 6 repetitions. We can only fit 18 individuals in each system.

6 reps \* 3 species \* 5 temperature regimes \* 2 temporal blocks = 180 crabs\

**Methods**

Crabs were collected and brought into GMS via SCUBA, intertidally, or trapping. Only males with 2 or less missing legs were used in the study. Upon entry into the lab, crabs were weight and carapace length was measured.
Crabs were placed into 5 gallon buckets in a wet table with a recirculating seawater system. Each were supplied with a water line and air line. There were two wet tables for one system which was set to one temperature treatment. The temperature treatments were
18, 20, 22, 24, and 26 degrees celcius.

Crabs were fed 3 times a week with clam and squid in an alternating pattern. Crabs were acclimated for the trial temperature for two weeks and fed an additional 3 times for the feeding trial.

## Data Processing

```{R, include = FALSE, warning = FALSE}
library(ggplot2)
library(lubridate)
library(hms)
library(dplyr)
library(emmeans)
library(knitr)
library(brglm)
library(glmmTMB)
library(DHARMa)
library(MuMIn)
library(glmm)
library(lmerTest)
setwd("/Users/chanceyan/Documents/R/ThesisCrab/Data")
crabdata <- read.csv("Feeding.csv", h=T, stringsAsFactors = FALSE)
death <- read.csv("DeathCount.csv", h=T, stringsAsFactors = FALSE)
master <- read.csv("Master.csv", h=T, stringsAsFactors = FALSE)
deathMeta <- read.csv("Death.csv", h=T, stringsAsFactors = FALSE)
husbandry <- read.csv("Husbandry.csv", h=T, stringsAsFactors = FALSE)
checkout <- read.csv("CheckOut.csv", h=T, stringsAsFactors = FALSE)
```

#### Cleaning up data for use

We need to clean up the data first to use it. What I did...

NOTE: "feeding points" refer to a measurement of feeding. Therefore we have multiple feeding points from a single individual crab. 

-   Removed feeding points that used mussels and mackerel. We fed two days total of mussels and mackerel to find out that it was too difficult to measure accurately. Afterwards, we switched to Clam and Squid in an alternating pattern
-   I then removed those who molted (removed as in removed all feeding points that individual contributed to the dataset) as molting has been shown in the literature to affect feeding rate.
-   I removed the first week and first period of feeding from Trial 18 and 22 since they were fed two days in a row (accidentally + understanding methods). They still had 3 weeks of feeding (2 weeks of acclimation similar to the other trials).
-   I removed feeding points for those who ate everything that we fed them. This is because it's possible they could have eaten more and the point becomes inaccurate. 
-   Very rarely (around 4-5 times total), food would be found floating in the bucket after waiting the feeding period. I have removed these feeding points as well because the crab couldn't get to the food and eat for the feeding period and therefore the point cannot be trusted
-   The rest of the code is marking individuals if they've eaten or not, still eaten, making extra variables so that further analyses are easier.

```{R include = FALSE, warning = FALSE}
#removing rows that contain no data or recorded incorrectly
for(i in 1:nrow(crabdata)){
  if(!is.numeric(crabdata[i,4])){
    print(crabdata[i])
    crabdata <- crabdata[-i,]
  }
  if(!is.numeric(crabdata[i,6])){
    print(crabdata[i])
    crabdata <- crabdata[-i,]
  }
}

#Creating number IDs for each crab based of their IDs so it's easier to loop through with future code. Also I'm adding a total eaten by proportion column, so we have a standard metric to compare by.
for(i in 1:36){
  master$num[[i]] <- substr(master$ID[[i]], 3,5)
}

crabdata$amount.eaten <- crabdata$FoodIn-crabdata$FoodOut
all <- merge(crabdata, master, by="ID")

#renaming temperature.x to temperature
all <- all %>% dplyr::select(-Temperature.y)
names(all)[names(all) == "Temperature.x"] <- "Temperature"

#Changing date column into a date data type, so that R can read it as a Date.
all$Date.x = as.Date(all$Date.x, format = "%m/%d/%Y")
deathMeta$Date = as.Date(deathMeta$Date, format = "%m/%d/%Y")

#removing mussel and mackerel feed
all <- subset(all, all$Food != "Mussels")
all <- subset(all, all$Food != "Mackerel")


#saving those who molted in an original dataset
original_molted <- all
original_molted$molted <- ifelse(grepl("ME", original_molted$Notes.x, fixed = TRUE), "YES", "NO")

#Removing those that molted
array <- c()

for(i in 1:nrow(all)){
  if(grepl("ME", all$Notes.x[i], fixed = TRUE)){
    ID_value <- all$ID[i]
    for(j in 1:nrow(all)){
      if(all$ID[j] == ID_value){
        array <- c(array, j)
      }
    }
  }
}

all <- all[-array,]
array <- c()

#Removing these dates because feeding was not following a strict schedule (fed two days back to back)
all <- subset(all, !(WeekNum == 1 & Temperature == 16))
all <- subset(all, !(WeekNum == 1 & Temperature == 22 & Period == 1))

#Changing trials 16 and 18 to be one.
original <- all
all$Temperature <- ifelse(all$Temperature == 16, 18, all$Temperature)
original$Temperature <- ifelse(original$Temperature == 16, 18, original$Temperature)
master$Temperature <- ifelse(master$Temperature == 16, 18, master$Temperature)

#Here, I am marking all those who did not eat
EatDF <- subset(all, grepl("DE", all$Notes.x, fixed = TRUE))

#removing all those who ate everything
all <- all[ !grepl("AE", all$Notes.x), ]

#removing all those who were found to have floating food
all <- all[ !grepl("FLOAT", all$Notes.x), ]

#Making a new column indicating whether the animal ate or not
eaten_row <- list()
for(i in 1:nrow(all)){
  if(grepl("DE", all$Notes.x[i], fixed = TRUE)){
    eaten_row <- c(eaten_row, "NO")
  }
  else{
    eaten_row <- c(eaten_row, "YES")
  }
}
all$eaten <- eaten_row

#Making a column if the animal was still eating or not
all$still_eating <- ifelse(grepl("SE", all$Notes.x, fixed = TRUE), "YES", "NO")

inBucket <- list()
#total time of food in bucket
all$TimeInStrip <- as.POSIXct(paste(all$Date.x, all$TimeIn), format = "%Y-%m-%d %I:%M:%S %p")
all$TimeOutStrip <- as.POSIXct(paste(all$Date.x, all$TimeOut), format = "%Y-%m-%d %I:%M:%S %p")

#because we removed the first week from trials 1 and 2, to get the final week, I'll just subtract one from the value to line it up so that week 4 equals week 3 and make it easier for me to graph

all$WeekNum <- ifelse((all$Temperature == 18 & all$WeekNum == 2 & all$Period == 1), 1, all$WeekNum)
all$WeekNum <- ifelse((all$Temperature == 18 & all$WeekNum == 3 & all$Period == 1), 2, all$WeekNum)
all$WeekNum <- ifelse((all$Temperature == 18 & all$WeekNum == 4 & all$Period == 1), 3, all$WeekNum)

all$WeekNum <- ifelse((all$Temperature == 22 & all$WeekNum == 2 & all$Period == 1), 1, all$WeekNum)
all$WeekNum <- ifelse((all$Temperature == 22 & all$WeekNum == 3 & all$Period == 1), 2, all$WeekNum)
all$WeekNum <- ifelse((all$Temperature == 22 & all$WeekNum == 4 & all$Period == 1), 3, all$WeekNum)

#making a new ID for those that are placements
all$ID <- ifelse(grepl("RE", all$Notes.x), paste(all$ID, "R"), all$ID)

#husbandry sheet prep
husbandry <- subset(husbandry, husbandry$Trial != "NONE")
```

We have some decisions to make, but we'll boil it down to the all-inclusive model vs the censoring model

All-inclusive model: 
-Add in all those who died as zeros and even beyond after they died they still remain as 0's. 
-Also keep in replacement data.
-Keep crabs who died as is in the data set

Censoring model: 
-Remove feeding points from all those who died and those who were replacement.
-Turn all the feeding points of those who did not eat to 0
-Remove dead individual

ALL-INCLUSIVE MODEL:
-Includes all those who died, data points after they've died becomes 0
-Incudes those that were replaced as well
```{R}
inclusive <- all

inclusive$proportion.eaten <- inclusive$amount.eaten / inclusive$WW
inclusive <- subset(inclusive, !is.na(inclusive$proportion.eaten))
```

CENSORING MODEL:
-Removes those who died completely and those who were used to be replaced. 
-Sets those who didn't eat to 0 (for feeding points)
```{R}
censor <- all

censor$amount.eaten <- ifelse(grepl("DE", censor$Notes.x, fixed = TRUE), 0, censor$amount.eaten)
censor$amount.eaten <- ifelse(censor$amount.eaten < 0, 0, censor$amount.eaten)

censor <- censor[is.na(censor$Date.x) | !(censor$ID %in% deathMeta$ID),]


censor <- censor %>% filter(!grepl("DI", Notes.x))
censor <- censor %>% filter(!grepl("ADDI", Notes.x))
censor <- censor %>% filter(!grepl("RE", Notes.x))
censor <- censor %>% filter(!grepl("molted", Notes.x))

censor$proportion.eaten <- censor$amount.eaten / censor$WW
censor <- subset(censor, !is.na(censor$proportion.eaten))
```

### Basic information on the dataset (Post Data Modifications)

```{r echo = FALSE, warning = FALSE}
#inclusive model
a <- tapply(inclusive$ID, list(inclusive$Species.x, inclusive$Temperature), FUN = function(x) length(unique(x)))
b <- tapply(inclusive$proportion.eaten, list(inclusive$Species.x, inclusive$Temperature), FUN = length)

#censor model
d <- tapply(censor$ID, list(censor$Species.x, censor$Temperature), FUN = function(x) length(unique(x)))
e <- tapply(censor$proportion.eaten, list(censor$Species.x, censor$Temperature), FUN = length)

kable(rbind(Inclusive = a, Censor = d), caption = "Inclusive on top, Censor on the bottom. Number of Individuals")
kable(rbind(Inclusive = b, Censor = e), caption = "Inclusive on top, Censor on the bottom. Number of Feeding Points")
```

### Death OR Alive: Are there differences in the amount of alive/dead individuals as temperature increases? Which species out of the three is this relationship the strongest?

What I did:
-I added the extras on the master dataframe which contains all individuals who were ever in the systems that are included in the project
-I then created two exploratory graphs to represent how the data looks in general - NOTE - a good model should show that there is an DECREASe in alive individuals as temperature increases for the Rock Crab. Greeb crabs and shore crabs should remain relatively flat (no increase death with temperatures)
-To account for the separated data I will use a bias reduced GLM. Following code from: https://bscheng.com/2016/12/11/modeling-completely-separated-data-in-r/
-I then fit the model to an all mod (all explanatory variables added with interactions). Then dredged the model to see which model is the "best"
-The best model came back as one that included temperature and Species (all explanatory variables); however, without interactions
-Best model <- dead ~ Temperature(numeric) + Species
-This best model summary tells us there are differences in the INTERCEPTS between green crabs/shore crabs and rock crabs. The model also indicates that there is a slope that is negative for ALL species. This is because we did not include an interaction (including an interaction makes the model find no differences and AIC finds no interaction model a worse one)
-Since it seems obvious that rock crabs are doing worse than green crabs and shore crabs (a little disappointed it didn't pick it up), I modeled with just rock crab data
-I modeled just rock crab data and found that there was a signficantly negative slope as temperature increases.

Summary: I modeled dead and alive crabs using a bias reduced GLM. After dredging the best model was a full addivite model (temperature and species); however, the model dictataes all species have the same slope (decrease of alive individuals across temperature) and therefore I modeled just rock crabs to see a negative slope (decrease in alive individuals)

```{R}
#parsing between those who died during the experiment and those who lived
master$dead <- ifelse(master$ID %in% deathMeta$ID, 0, 1)	

#changing name from Trial to Temperature to avoid confusion
names(master)[names(master) == "Trial"] <- "Temperature"

#addition of extras
{
add_rows <- data.frame(ID = "extra1_26", System = NA, CL = NA, WW = NA, Temperature = 26, Species = "Irroratus", Condition = NA, Period = NA, Date = NA, Notes = NA, num = NA, dead = 0)
master <- rbind(master, add_rows)
add_rows <- data.frame(ID = "extra2_26", System = NA, CL = NA, WW = NA, Temperature = 26, Species = "Irroratus", Condition = NA, Period = NA, Date = NA, Notes = NA, num = NA, dead = 0)
master <- rbind(master, add_rows)
add_rows <- data.frame(ID = "extra1_24", System = NA, CL = NA, WW = NA, Temperature = 24, Species = "Irroratus", Condition = NA, Period = NA, Date = NA, Notes = NA, num = NA, dead = 0)
master <- rbind(master, add_rows)
add_rows <- data.frame(ID = "extra2_24", System = NA, CL = NA, WW = NA, Temperature = 24, Species = "Irroratus", Condition = NA, Period = NA, Date = NA, Notes = NA, num = NA, dead = 1)
master <- rbind(master, add_rows)
add_rows <- data.frame(ID = "extra1_22", System = NA, CL = NA, WW = NA, Temperature = 22, Species = "Irroratus", Condition = NA, Period = NA, Date = NA, Notes = NA, num = NA, dead = 1)
master <- rbind(master, add_rows)
add_rows <- data.frame(ID = "extra2_22", System = NA, CL = NA, WW = NA, Temperature = 22, Species = "Irroratus", Condition = NA, Period = NA, Date = NA, Notes = NA, num = NA, dead = 1)
master <- rbind(master, add_rows)
add_rows <- data.frame(ID = "extra1_20", System = NA, CL = NA, WW = NA, Temperature = 20, Species = "Irroratus", Condition = NA, Period = NA, Date = NA, Notes = NA, num = NA, dead = 1)
master <- rbind(master, add_rows)
add_rows <- data.frame(ID = "extra2_20", System = NA, CL = NA, WW = NA, Temperature = 20, Species = "Irroratus", Condition = NA, Period = NA, Date = NA, Notes = NA, num = NA, dead = 1)
master <- rbind(master, add_rows)
add_rows <- data.frame(ID = "extra1_18", System = NA, CL = NA, WW = NA, Temperature = 18, Species = "Irroratus", Condition = NA, Period = NA, Date = NA, Notes = NA, num = NA, dead = 1)
master <- rbind(master, add_rows)
add_rows <- data.frame(ID = "extra2_18", System = NA, CL = NA, WW = NA, Temperature = 18, Species = "Irroratus", Condition = NA, Period = NA, Date = NA, Notes = NA, num = NA, dead = 1)
master <- rbind(master, add_rows)
}

mastergraph <-  master %>%
  count(Species, Temperature, dead) %>%
  group_by(Species, Temperature) %>%
  mutate(
    proportion = n / sum(n)
  )

mastergraph$dead <- factor(mastergraph$dead, levels = c(1,0))

ggplot(mastergraph, aes(x = Temperature, y = proportion, fill = dead)) + geom_col() + facet_wrap(~Species)+
  scale_fill_manual(values = c("0" = "darkred", "1" = "darkgreen")) + ggtitle("Proportion of crab deaths across temperature")

mastergraph <- master
mastergraph$dead <- factor(mastergraph$dead, levels = c(0,1))

ggplot(mastergraph, aes(x = Temperature, y = dead, color = dead)) + geom_point(position = position_jitter(width = 0.005)) +
  geom_smooth(aes(group = 1), method = "loess", se = FALSE) +
  xlab("Temperature")+
  ylab("Count")+
  facet_wrap(~Species)+
  ggtitle("The counts of dead vs alive individuals in each trial for each species")+
  scale_color_manual(values = c("0" = "darkred", "1" = "darkgreen"))

#using 
all.mod <- brglm(dead ~ Temperature*Species, family = binomial, data = master, na.action = "na.fail")
dredge(all.mod, rank = "AICc")

#the best mod is inclusion of Species and Trial with no interaction
best.mod <- brglm(dead ~ Temperature + Species, family = binomial, data = master, na.action = "na.fail")
summary(best.mod)
#what's the best way to create diagnostic plots for this?

master$Species <- factor(master$Species)
newdat <- expand.grid(Temperature = seq(min(master$Temperature), max(master$Temperature), length.out = 100), Species = levels(master$Species))
newdat$Species <- factor(newdat$Species, levels = levels(master$Species))

newdat$pred <- predict(best.mod, newdata = newdat, type = "response")

ggplot(master, aes(x = Temperature, y = dead, color = Species)) +
  geom_point(position = position_jitter(height = 0.05), alpha = 0.6) +
  geom_line(data = newdat, aes(x = Temperature, y = pred, color = Species), linewidth = 1) +
  scale_y_continuous(limits = c(0, 1)) + 
  ggtitle("The number of dead (0) vs alive (1) crabs across 5 different temperatures") + 
  scale_color_manual(values = c("Carcinus" = "darkgreen",
                                "Hemigrapsus" = "darkred",
                                "Irroratus" = "darkorange"))

#just Cancer irroratus
holddf <- subset(master, master$Species == "Irroratus")
all.mod <- brglm(dead ~ Temperature, family = binomial, data = holddf, na.action = "na.fail")
dredge(all.mod, rank = "AICc")
best.mod <- brglm(dead ~ Temperature, family = binomial, data = holddf, na.action = "na.fail")
summary(best.mod)

newdat <- data.frame(Temperature = seq(min(holddf$Temperature), max(holddf$Temperature), length.out = 100))

newdat$pred <- predict(best.mod, newdata = newdat, type = "response")

ggplot(holddf, aes(x = Temperature, y = dead)) +
  geom_point(position = position_jitter(height = 0.05), alpha = 0.6) +
  geom_line(data = newdat, aes(x = Temperature, y = pred), color = "darkorange", linewidth = 1) +
  scale_y_continuous(limits = c(0, 1)) + 
  ggtitle("The number of dead (0) vs alive (1) Atlantic rock crabs across 5 different temperatures")
```

### Acclimation: Are there differences in proportion eaten across week number for each species, temperature regime and time period?

-I started by graphing what we would expect the acclimation models to suggest.
-If acclimation worked, we should expect an increase or decrease in the first week to the second then it should hit a flat line (indicating no change in consumption) going from week 2 to 3. That would indicate 2 weeks of acclimation is sufficient for measuring consumption
-I summarized the mean and standard error for each species, temperature and period then graphed the proportion consumed over week number to test if the acclimation worked. I also compared these graphs between the censor model and inclusive model
-I found very little differences (visually) between the inclusive and censor model
-It seems like there are very little differences between all weeks for rock crabs and green crabs; however, we do see some differences in shore crabs between the week numbers. Hopefully our model reflects this.
-Off to modeling!

Modeling Acclimation:
-Each species was modeled separately as we are only interested in if the acclimation time was sufficient (i.e. consumption rate is stable after two weeks of acclimation)
-Further, each temperature was modeled independently of each other because we do not care about differences among different temperature treatments.
-I started by graphing out response variables for each species. Green crabs and shore crabs seem to be relatively normal while rock crabs have some potential weirdness.
-For each species, I tested which model worked best for temperature treatment 18 and then applied that model to the rest of the temperature treatments and checked for fit

Model fits:
-Green crabs: Their response variable was mainly normal, so I started by using a GLM with a family of gaussian. After checking the diagnostics, the models seem to be a good fit across all temperature treatments
-Shore crabs: The previous steps were repeated and I found the model fit was ok for all the temperature treatments (family = gaussian)
-Rock crabs: The typically normal GLM did not fit well for these crabs. I tried other models such as Gamma; however, found poor fit in all. Even transforming the data did not work. I then decided to model it with zero-inflation as I noticed it in the graphs. Modeling with zero-inflation provided a strong fit for all temperature treatments; however, for temperature treatment 20 I fitted a zero-inflated gaussian model rather than a Gamma model (which are the rest) since the distribution of the response variable was normal and the model was a better fit then a Gamma for 20 C temperature treatment.

Pairwise comparisons:
-I then made pairwise comparisons between each week number for all species and temperature treatments.
-Reminder: We are looking for differences between week number 2 and 3. If there are no differences this will indicate consumption has flattened and stablized. If not, then feeding may potentially continue to increase or decrease.
-Green crabs: No differences between any groups
-Shore crabs: some temperature treatments have differences between groups (importantly between week 2 and 3). The only temperature treatments where we see differences between week 2 and 3 are temperature treatments 22C and 24C
Additional note for shore crabs: Both differences between week 2 and 3 for temperature treatments 22 C and 24 C are always decrease from week 2 to 3 (week 3 is always smaller amount) - as noted before this may be a saturation effect. Crabs are eating more than enough and therefore will opt out of feeding more in future feedings.
-Rock crabs: No differences between week 2 and 3 for all temperature treatments, but some have differences between week 1 and 3

TLDR: I first made exploratory graphs, then modeled each species and temperature treatment separately. I used GLMs for shore and green crabs while I used zero-inflated models for rock crabs. All models fit well and the only difference between week 2 and 3 consumption rate lies within temperature treamtment 22C and 24 C for shore crabs.

```{R echo = FALSE, warning = FALSE}
summary_inclusive <- inclusive %>%
  group_by(Species.x, Temperature, Period, WeekNum) %>%
  summarise(
    mean = mean(proportion.eaten),
    se = sd(proportion.eaten) / sqrt(n())
  )

summary_inclusive$SpeciesPeriod <- paste(summary_inclusive$Species.x, summary_inclusive$Period, sep = "_")

summary_censor <- censor %>%
  group_by(Species.x, Temperature, Period, WeekNum) %>%
  summarise(
    mean = mean(proportion.eaten),
    se = sd(proportion.eaten) / sqrt(n())
  )

summary_censor$SpeciesPeriod <- paste(summary_censor$Species.x, summary_censor$Period, sep = "_")

#INCLUSIVE MODEL
ggplot(summary_inclusive, aes(x = as.numeric(WeekNum), y = mean, color = SpeciesPeriod)) + 
  geom_point(position = position_dodge(width = 0.2)) + 
  facet_wrap(~as.factor(Temperature)) +
  ggtitle("Proportion consumed over week number for the inclusive model") + 
  geom_smooth(method = "loess", se = FALSE)+
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), position = position_dodge(width = 0.2))+
  scale_color_manual(values = c("CI_1" = "darkorange3",
                     "CI_2" = "orange",
                     "CM_1" = "darkgreen",
                     "CM_2" = "green3",
                     "HS_1" = "darkred",
                     "HS_2" = "red3"))

#CENSOR MODEL
ggplot(summary_censor, aes(x = as.numeric(WeekNum), y = mean, color = SpeciesPeriod)) + 
  geom_point(position = position_dodge(width = 0.2)) + 
  facet_wrap(~as.factor(Temperature)) +
  ggtitle("Proportion consumed over week number for the censor model") + 
  geom_smooth(method = "loess", se = FALSE)+
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), position = position_dodge(width = 0.2))+
  scale_color_manual(values = c("CI_1" = "darkorange3",
                     "CI_2" = "orange",
                     "CM_1" = "darkgreen",
                     "CM_2" = "green3",
                     "HS_1" = "darkred",
                     "HS_2" = "red3"))

#going forward, I'll do data exploration with the censor model since the graphs looked very similar.

#both response variables are skewed
hist(censor$proportion.eaten)
hist(inclusive$proportion.eaten)

#"We assume that the error terms, and the observations, within each group come from normally distributed populations ... in each group"
#I need to test normality within group

ggplot(censor, aes(y = proportion.eaten, fill = Species.x)) + geom_boxplot() + 
  scale_fill_manual(values = c("CI" = "darkorange",
                    "CM" = "darkgreen",
                    "HS" = "darkred")) + ggtitle("Boxplot of Censor Model")

ggplot(censor, aes(x = proportion.eaten, fill= Species.x)) + geom_histogram()+ 
  scale_fill_manual(values = c("CI" = "darkorange",
                    "CM" = "darkgreen",
                    "HS" = "darkred")) + facet_wrap(~Species.x, scales = "free") + ggtitle("Histogram of Censor Model")

ggplot(inclusive, aes(y = proportion.eaten, fill = Species.x)) + geom_boxplot() + 
  scale_fill_manual(values = c("CI" = "darkorange",
                    "CM" = "darkgreen",
                    "HS" = "darkred")) + ggtitle("Boxplot of Inclusive Model")

ggplot(inclusive, aes(x = proportion.eaten, fill= Species.x)) + geom_histogram()+ 
  scale_fill_manual(values = c("CI" = "darkorange",
                    "CM" = "darkgreen",
                    "HS" = "darkred")) + facet_wrap(~Species.x, scales = "free")+ ggtitle("Histogram of Inclusive Model")

#I'll be modeling each species independently since I am interested in how each species responds on their own and not differences between other species (I want to know if acclimation worked or not so it doesn't involve other species)
#Further, I want to understand how each week number differs WITHIN temperature. Therefore, it is probably best to model each temperature on their own
#NOTE: Temperature is being taken as a factor here since we only care about within temperature treatments!
#I'll only be using the censor model since it lacks negatives and it's easier to handle. Also, preliminary graphs suggests data is very similar and both aren't needed for all comparisons (I will compare final models)
#let's begin with green crabs since they are normal and "easier" to handle

#week number will be used as a factor since we care about direct differences between week 1 and 3 not just if it increases across the weeks
#we'll use a GLM and add, Week number as the only explanatory variable. We'll model specific temperatures and species on their own.

#GREEN CRABS------------------------------------------------------------------------

par(mfrow=c(2,2))

#Temperature 18 - #No differences between week numbers and model fits well
censorsub <- subset(censor, censor$Species.x == "CM" & censor$Temperature == 18)
mod <- glm(proportion.eaten ~ as.factor(WeekNum), data = censorsub)
plot(mod)
summary(mod)

#Temperature 20 - #No differences between week numbers and model fits well
censorsub <- subset(censor, censor$Species.x == "CM" & censor$Temperature == 20)
mod <- glm(proportion.eaten ~ as.factor(WeekNum), data = censorsub)
plot(mod)
summary(mod)

#Temperature 22 - #No differences between week numbers and model fits well
censorsub <- subset(censor, censor$Species.x == "CM" & censor$Temperature == 22)
mod <- glm(proportion.eaten ~ as.factor(WeekNum), data = censorsub)
plot(mod)
summary(mod)

#Temperature 24 - #No differences between week numbers and model fits well
censorsub <- subset(censor, censor$Species.x == "CM" & censor$Temperature == 24)
mod <- glm(proportion.eaten ~ as.factor(WeekNum), data = censorsub)
plot(mod)
summary(mod)

#Temperature 26 - #No differences between week numbers and model fits well
censorsub <- subset(censor, censor$Species.x == "CM" & censor$Temperature == 26)
mod <- glm(proportion.eaten ~ as.factor(WeekNum), data = censorsub)
plot(mod)
summary(mod)

#For green crabs, there are no differences between week number within each Temperature treatment

#SHORE CRABS ------------------------------------------------------------------

#shore crabs had a semi normal shape...? Some skew, so I'll try a GLM with normal distribution first and see how well the model does
#again, I'll model the temperatures separately as I only care about differences within treatment

par(mfrow=c(2,2))

#Temperature 18 - Ok fit... let's try a Gamma family
censorsub <- subset(censor, censor$Species.x == "HS" & censor$Temperature == 18)
mod1 <- glm(proportion.eaten ~ as.factor(WeekNum), data = censorsub)
plot(mod1)
summary(mod1)

#since 0's aren't allowed changing 0's to .001
censorsub$proportion.eaten <- ifelse(censorsub$proportion.eaten <= 0, 0.001, censorsub$proportion.eaten)
mod2 <- glm(proportion.eaten ~ as.factor(WeekNum), data = censorsub, family = Gamma(link = "inverse"))
plot(mod2)
summary(mod2)

mod3 <- glm(proportion.eaten ~ as.factor(WeekNum), data = censorsub, family = Gamma(link = "identity"))
plot(mod3)
summary(mod3)

AIC(mod1, mod2, mod3)

#mod1 is best that says there are no differences between groups
emm <- emmeans(mod1, ~as.factor(WeekNum))
pairs(emm, adjust = "tukey")

#mod1 is the best (normal model)
#after trying all of them, they all say the same thing - no differences between weeks

#Temperature 20 - Fit is OK, Week 2 and 3 are not different, but week 1 is different from week 2 and 3
censorsub <- subset(censor, censor$Species.x == "HS" & censor$Temperature == 20)
mod <- glm(proportion.eaten ~ as.factor(WeekNum), data = censorsub)
plot(mod)
summary(mod)
emm <- emmeans(mod, ~as.factor(WeekNum))
pairs(emm, adjust = "tukey")

#Temperature 22 - Fit is good, only difference is between week 2 and 3 - CAUTION WHEN DOING FINAL ANAYSIS - MIGHT AFFECT USING WEEK 2 AND 3
censorsub <- subset(censor, censor$Species.x == "HS" & censor$Temperature == 22)
mod <- glm(proportion.eaten ~ as.factor(WeekNum), data = censorsub)
plot(mod)
summary(mod)
emm <- emmeans(mod, ~as.factor(WeekNum))
pairs(emm, adjust = "tukey")

#Temperature 24 - Fit is good, one outlier that ate almost half of it's body weight
#no difference between week 1 and 2, but differences between 1-3 and 2-3
censorsub <- subset(censor, censor$Species.x == "HS" & censor$Temperature == 24)
mod <- glm(proportion.eaten ~ as.factor(WeekNum), data = censorsub)
plot(mod)
summary(mod)
emm <- emmeans(mod, ~as.factor(WeekNum))
pairs(emm, adjust = "tukey")

#Temperature 26 - Fit is good, 3 outliers, no differences among groups. 
censorsub <- subset(censor, censor$Species.x == "HS" & censor$Temperature == 26)
mod <- glm(proportion.eaten ~ as.factor(WeekNum), data = censorsub)
plot(mod)
summary(mod)
emm <- emmeans(mod, ~as.factor(WeekNum))
pairs(emm, adjust = "tukey")

#there are differences between weeks 2 and 3 for some temperature treatments

#CI-----------------------------------------------------------------------------

hist(censorsub$proportion.eaten)

#Temperature 18 - worse fit, trying Gamma
censorsub <- subset(censor, censor$Species.x == "CI" & censor$Temperature == 18)
mod1 <- glm(proportion.eaten ~ as.factor(WeekNum), data = censorsub)
plot(mod1)
#since 0's aren't allowed changing 0's to .001
censorsub$proportion.eaten <- ifelse(censorsub$proportion.eaten <= 0, 0.001, censorsub$proportion.eaten)
mod2 <- glm(proportion.eaten ~ as.factor(WeekNum), data = censorsub, family = Gamma(link = "inverse"))
plot(mod2)
mod3 <- glm(proportion.eaten ~ as.factor(WeekNum), data = censorsub, family = Gamma(link = "logit"))
plot(mod3)
mod4 <- glm(proportion.eaten ~ as.factor(WeekNum), data = censorsub, family = Gamma(link = "log"))
plot(mod4)

AIC(mod1, mod2, mod3, mod4)

#ok, since all models are a poor fit, let's try transforming the data
censorsub <- subset(censor, censor$Species.x == "CI" & censor$Temperature == 18)
#since some values are 0 add 1 to it then square
censorsub$proportion.eaten.sqrt <- sqrt(censorsub$proportion.eaten + .001)
hist(censorsub$proportion.eaten.sqrt)
#transforming the data isn't a good fit, let's try a zero-inflated model
mod1 <- glm(proportion.eaten.log ~ as.factor(WeekNum), data = censorsub)
plot(mod1)

#the zero-inflated model is a good fit! no differences for zeros and continous values between the weeks
ZIglm <- glmmTMB(proportion.eaten ~ as.factor(WeekNum), data = censorsub, ziformula = ~as.factor(WeekNum), family = ziGamma((link= "inverse")))
ZIglm.resids <- simulateResiduals(ZIglm)
plot(ZIglm.resids)
summary(ZIglm)
emm <- emmeans(ZIglm, ~ as.factor(WeekNum), type = "response")
pairs(emm)

#Temperature 20 - better fit for normal data, when graphing out the response for CI at 20, it is normal except for the zero grouping
#There are differences between 1-2 and 1-3, but week 2-3 are the same
censorsub <- subset(censor, censor$Species.x == "CI" & censor$Temperature == 20)
ZIglm <- glmmTMB(proportion.eaten ~ as.factor(WeekNum), data = censorsub, ziformula = ~as.factor(WeekNum))
ZIglm.resids <- simulateResiduals(ZIglm)
plot(ZIglm.resids)
summary(ZIglm)
emm <- emmeans(ZIglm, ~ as.factor(WeekNum), type = "response")
pairs(emm)

#Temperature 22 - good fit, no differences between any groups
censorsub <- subset(censor, censor$Species.x == "CI" & censor$Temperature == 22)
ZIglm <- glmmTMB(proportion.eaten ~ as.factor(WeekNum), data = censorsub, ziformula = ~as.factor(WeekNum), family = ziGamma((link= "inverse")))
ZIglm.resids <- simulateResiduals(ZIglm)
plot(ZIglm.resids)
summary(ZIglm)
emm <- emmeans(ZIglm, ~ as.factor(WeekNum), type = "response")
pairs(emm)

#Temperature 24 - good fit, no differences between week numbers
censorsub <- subset(censor, censor$Species.x == "CI" & censor$Temperature == 24)
ZIglm <- glmmTMB(proportion.eaten ~ as.factor(WeekNum), data = censorsub, ziformula = ~as.factor(WeekNum), family = ziGamma((link= "inverse")))
ZIglm.resids <- simulateResiduals(ZIglm)
plot(ZIglm.resids)
summary(ZIglm)
emm <- emmeans(ZIglm, ~ as.factor(WeekNum), type = "response")
pairs(emm)

#Temperature 26 - Good fit, no difference!
censorsub <- subset(censor, censor$Species.x == "CI" & censor$Temperature == 26)
ZIglm <- glmmTMB(proportion.eaten ~ as.factor(WeekNum), data = censorsub, ziformula = ~as.factor(WeekNum), family = ziGamma((link= "inverse")))
ZIglm.resids <- simulateResiduals(ZIglm)
plot(ZIglm.resids)
summary(ZIglm)
emm <- emmeans(ZIglm, ~ as.factor(WeekNum), type = "response")
pairs(emm)

```

### The Big Question: Are there differences in consumption rate across different species and temperature?

```{R, echo=FALSE,results='hide',fig.keep='all'}
#I'm interested in understanding differences in proportion consumed across species and temperature. The period may also be a factor that affects proportion comsumed, so first I'll check if it does have an affect for proportion consumed.
#To check for differences across period, we'll check within trial and species

#CI--------------------------------------------------------------------------

#Gamma distribution with inflated 0 -> model fits well and says NO DIFFERENCE between periods
censorsub <- subset(censor, censor$Species.x == "CI" & Temperature == 18)
hist(censorsub$proportion.eaten)
ZIglm <- glmmTMB(proportion.eaten ~ as.factor(Period), data = censorsub, ziformula = ~as.factor(Period), family = ziGamma((link= "inverse")))
ZIglm.resids <- simulateResiduals(ZIglm)
plot(ZIglm.resids)
summary(ZIglm)

#normal distribution with inflated 0 -> model fits well and says there is a DIFFERENCE between the periods
censorsub <- subset(censor, censor$Species.x == "CI" & Temperature == 20)
hist(censorsub$proportion.eaten)
ZIglm <- glmmTMB(proportion.eaten ~ as.factor(Period), data = censorsub, ziformula = ~as.factor(Period))
ZIglm.resids <- simulateResiduals(ZIglm)
plot(ZIglm.resids)
summary(ZIglm)

#poor fit for zero inflated, good fit for normal GLM (distribution is more normal). NO DIFFERENCE found in either model
censorsub <- subset(censor, censor$Species.x == "CI" & Temperature == 22)
hist(censorsub$proportion.eaten)
ZIglm <- glmmTMB(proportion.eaten ~ as.factor(Period), data = censorsub, ziformula = ~as.factor(Period))
ZIglm.resids <- simulateResiduals(ZIglm)
plot(ZIglm.resids)
summary(ZIglm)

mod <- glm(proportion.eaten ~ as.factor(Period), data = censorsub)
plot(mod)
summary(mod)

#Model is a good fit, NO DIFFERENCE between periods
censorsub <- subset(censor, censor$Species.x == "CI" & Temperature == 24)
hist(censorsub$proportion.eaten)
ZIglm <- glmmTMB(proportion.eaten ~ as.factor(Period), data = censorsub, ziformula = ~as.factor(Period), family = ziGamma((link= "inverse")))
ZIglm.resids <- simulateResiduals(ZIglm)
plot(ZIglm.resids)
summary(ZIglm)

#good fit, NO DIFFERENCE between periods
censorsub <- subset(censor, censor$Species.x == "CI" & Temperature == 26)
hist(censorsub$proportion.eaten)
ZIglm <- glmmTMB(proportion.eaten ~ as.factor(Period), data = censorsub, ziformula = ~as.factor(Period), family = ziGamma((link= "inverse")))
ZIglm.resids <- simulateResiduals(ZIglm)
plot(ZIglm.resids)
summary(ZIglm)

#CM-----------------------------------------------------------------------------

#normal distribution, fitting a normal GLM. 
#good fit, NO DIFFERENCES between periods
censorsub <- subset(censor, censor$Species.x == "CM" & Temperature == 18)
hist(censorsub$proportion.eaten)
mod <- glm(proportion.eaten ~ as.factor(Period), data = censorsub)
plot(mod)
summary(mod)

#okay fit, NO DIFFERENCES between periods
censorsub <- subset(censor, censor$Species.x == "CM" & Temperature == 20)
hist(censorsub$proportion.eaten)
mod <- glm(proportion.eaten ~ as.factor(Period), data = censorsub, family = Gamma(link = "inverse"))
plot(mod)
summary(mod)

#good fit, NO DIFFERENCES between periods
censorsub <- subset(censor, censor$Species.x == "CM" & Temperature == 22)
hist(censorsub$proportion.eaten)
mod <- glm(proportion.eaten ~ as.factor(Period), data = censorsub)
plot(mod)
summary(mod)

#good fit, there are DIFFERENCES between periods
censorsub <- subset(censor, censor$Species.x == "CM" & Temperature == 24)
hist(censorsub$proportion.eaten)
mod <- glm(proportion.eaten ~ as.factor(Period), data = censorsub)
plot(mod)
summary(mod)

#good fit, NO DIFFERENCES between periods
censorsub <- subset(censor, censor$Species.x == "CM" & Temperature == 26)
hist(censorsub$proportion.eaten)
mod <- glm(proportion.eaten ~ as.factor(Period), data = censorsub)
plot(mod)
summary(mod)

#HS----------------------------------------------------------------------------

#both normal GLM, Gamma GLM, ZI Gamma (best fitting model) say NO DIFFERENCES
censorsub <- subset(censor, censor$Species.x == "HS" & Temperature == 18)
hist(censorsub$proportion.eaten)
censorsub$proportion.eaten <- ifelse(censorsub$proportion.eaten <= 0, .001, censorsub$proportion.eaten)
mod <- glm(proportion.eaten ~ as.factor(Period), data = censorsub, family = Gamma(link = "inverse"))
plot(mod)
summary(mod)

censorsub <- subset(censor, censor$Species.x == "HS" & Temperature == 18)
hist(censorsub$proportion.eaten)
ZIglm <- glmmTMB(proportion.eaten ~ as.factor(Period), data = censorsub, ziformula = ~as.factor(Period), family = ziGamma((link= "inverse")))
ZIglm.resids <- simulateResiduals(ZIglm)
plot(ZIglm.resids)
summary(ZIglm)

#good fit, there is a DIFFERENCE between periods
censorsub <- subset(censor, censor$Species.x == "HS" & Temperature == 20)
hist(censorsub$proportion.eaten)
mod <- glm(proportion.eaten ~ as.factor(Period), data = censorsub)
plot(mod)
summary(mod)

#good fit, There is NO DIFFERENCE between periods
censorsub <- subset(censor, censor$Species.x == "HS" & Temperature == 22)
hist(censorsub$proportion.eaten)
mod <- glm(proportion.eaten ~ as.factor(Period), data = censorsub)
plot(mod)
summary(mod)

#good fit, there is a DIFFERENCE between periods
censorsub <- subset(censor, censor$Species.x == "HS" & Temperature == 24)
hist(censorsub$proportion.eaten)
mod <- glm(proportion.eaten ~ as.factor(Period), data = censorsub)
plot(mod)
summary(mod)

#good fit, there is a DIFFERENCE between periods
censorsub <- subset(censor, censor$Species.x == "HS" & Temperature == 26)
hist(censorsub$proportion.eaten)
mod <- glm(proportion.eaten ~ as.factor(Period), data = censorsub, family = Gamma(link = "inverse"))
plot(mod)
summary(mod)

#PERIOD DIFFERENCES RESULTS------------------------------------------------------------------

#for CI, the only temperature treatment where there were differences between periods was temperature treatment 20
#for CM, the only differences were in temperature treatment 24
#for HS, temperature treatment 20, 24, 26 had differences in periods

#the rest of the temperatures were not different between periods
#Since there are differences between periods, but I am not interested in understanding how consumption changes over periods - I will include it in the model as a random effect

#Modeling---------------------------------------------------------------

#In the model, I will include, Species and Temperature and use Period as a random effect
#Exploring the data first.

#only accounting for final week of trial
finalEatCensor <- subset(censor, censor$WeekNum == 3)

summary_df_censor <- finalEatCensor %>%
  group_by(Species.x, Temperature, Period) %>%
  summarise(
    mean = mean(proportion.eaten),
    se = sd(proportion.eaten) / sqrt(n())
  )

finalEatInclusive <- subset(inclusive, inclusive$WeekNum == 3)

summary_df_inclusive <- finalEatInclusive %>%
  group_by(Species.x, Temperature, Period) %>%
  summarise(
    mean = mean(proportion.eaten),
    se = sd(proportion.eaten) / sqrt(n())
  )

ggplot(summary_df_censor, aes(x = as.numeric(Temperature), y = mean, color = Species.x)) + geom_point(position = position_dodge(width = 0.3))+
  scale_color_manual(values = c("HS" = "darkred",
                                 "CM" = "darkgreen",
                                 "CI" = "darkorange"))+
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se),
                width = 0.1, size = 0.8, position = position_dodge(width = 0.3)) +
  geom_smooth(method = "loess", se = FALSE)+ scale_y_log10()+
  ylab("Logged Mean of Proportion Eaten")+
  xlab("Trial Temperature") + labs(color = "Species")+
  ggtitle("Proportion Consumed over Trial Temperature for the censor model")

ggplot(summary_df_inclusive, aes(x = as.numeric(Temperature), y = mean, color = Species.x)) + geom_point(position = position_dodge(width = 0.3))+
  scale_color_manual(values = c("HS" = "darkred",
                                 "CM" = "darkgreen",
                                 "CI" = "darkorange"))+
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se),
                width = 0.1, size = 0.8, position = position_dodge(width = 0.3)) +
  geom_smooth(method = "loess", se = FALSE)+ scale_y_log10()+
  ylab("Logged Mean of Proportion Eaten")+
  xlab("Trial Temperature") + labs(color = "Species")+
  ggtitle("Proportion Consumed over Trial Temperature for the inclusive model")

#Little to no difference between censor and inclusive model.
#continue as usual with censor model since it's safer

#proportion eaten is super skewed when graphed out. Let's take a look at each species...
hist(finalEatCensor$proportion.eaten)

censorsub <- subset(finalEatCensor, finalEatCensor$Species.x == "CI")
#zero-inflated
hist(censorsub$proportion.eaten)
censorsub <- subset(finalEatCensor, finalEatCensor$Species.x == "CM")
#normal
hist(censorsub$proportion.eaten)
censorsub <- subset(finalEatCensor, finalEatCensor$Species.x == "HS")
#slight right skew
hist(censorsub$proportion.eaten)

#we can try graphing with Gamma family or even zero inflated to see if it'll work.
#we'll also dredge to get the best model.

finalEatCensor$Period <- factor(finalEatCensor$Period)

#GLM gamma and normal have poor fits
all.mod.glm.normal <- lmer(proportion.eaten ~ Species.x*Temperature + (1|Period), data = finalEatCensor, na.action = "na.fail")
dredge(all.mod.glm.normal)
best.mod.glm.normal <- glmer(proportion.eaten ~ Species.x+ (1|Period), data = finalEatCensor, na.action = "na.fail")
plot(best.mod.glm.normal)
qqnorm(residuals(best.mod.glm.normal))

#Trying zero-inflated gamma model
all.ZIglm <- glmmTMB(proportion.eaten ~ Species.x*Temperature + (1|Period), data = finalEatCensor, ziformula = ~1, family = ziGamma((link= "inverse")), na.action = "na.fail")
dredge(all.ZIglm)
ZIglm.resids <- simulateResiduals(all.ZIglm)

#poor fit
plot(ZIglm.resids)
summary(ZIglm)

#trying zero-inflated Gamma model
all.ZIglm <- glmmTMB(proportion.eaten ~ Species.x*Temperature + (1|Period), data = finalEatCensor, ziformula = ~1, family = ziGamma((link= "inverse")), na.action = "na.fail")
dredge(all.ZIglm)
ZIglm.resids <- simulateResiduals(all.ZIglm)
plot(ZIglm.resids)
summary(ZIglm)

#trying zero-inflated normal model
all.ZIglm <- glmmTMB(proportion.eaten ~ Species.x*Temperature + (1|Period), data = finalEatCensor, ziformula = ~1, na.action = "na.fail")
dredge(all.ZIglm)
ZIglm.resids <- simulateResiduals(all.ZIglm)
plot(ZIglm.resids)
summary(ZIglm)

censor_nozero <- finalEatCensor
censor_nozero$proportion.eaten <- ifelse(finalEatCensor$proportion.eaten <= 0, 0.001, finalEatCensor$proportion.eaten)
m_hurdle <- glmmTMB(
  proportion.eaten ~ Species.x * Temperature,
  data = censor_nozero,
  family = Gamma(link = "inverse"),
  ziformula = ~0,          # no ZI
  dispformula = ~1
)
ZIglm.resids <- simulateResiduals(m_hurdle)
plot(ZIglm.resids)
summary(ZIglm)

m_hurdle <- glmmTMB(
  proportion.eaten ~ Species.x * Temperature,
  data = censor_nozero,
  family = Gamma(link = "log"),
  ziformula = ~0,          # no ZI
  dispformula = ~1
)
ZIglm.resids <- simulateResiduals(m_hurdle)
plot(ZIglm.resids)
summary(m_hurdle)

m_tweedie <- glmmTMB(
  proportion.eaten ~ Species.x * Temperature,
  data = finalEatCensor,
  family = tweedie(link = "log")
)
ZIglm.resids <- simulateResiduals(m_tweedie)
plot(ZIglm.resids)
summary(m_hurdle)

#all models fail, let's sort by species then make comparisons across slope value

#Rock crab - zero-inflated -----------------------------------------------------
censorsub <- subset(finalEatCensor, finalEatCensor$Species.x == "CI")
hist(censorsub$proportion.eaten)

#model 6 and 10 come close
ZIglm1 <- glmmTMB(proportion.eaten ~ Temperature*Period, data = censorsub, ziformula = ~1, family = ziGamma((link= "inverse")),na.action = "na.fail")
ZIglm2 <- glmmTMB(proportion.eaten ~ Temperature + Period, data = censorsub, ziformula = ~1, family = ziGamma((link= "inverse")),na.action = "na.fail")
ZIglm3 <- glmmTMB(proportion.eaten ~ Period, data = censorsub, ziformula = ~1, family = ziGamma((link= "inverse")),na.action = "na.fail")
ZIglm4 <- glmmTMB(proportion.eaten ~ 1, data = censorsub, ziformula = ~1, family = ziGamma((link= "inverse")),na.action = "na.fail")
ZIglm5 <- glmmTMB(proportion.eaten ~ Temperature, data = censorsub, ziformula = ~1, family = ziGamma((link= "inverse")),na.action = "na.fail")
ZIglm6 <- glmmTMB(proportion.eaten ~ Temperature*Period, data = censorsub, ziformula = ~1,na.action = "na.fail")
ZIglm7 <- glmmTMB(proportion.eaten ~ Temperature + Period, data = censorsub, ziformula = ~1,na.action = "na.fail")
ZIglm8 <- glmmTMB(proportion.eaten ~ Period, data = censorsub, ziformula = ~1,na.action = "na.fail")
ZIglm9 <- glmmTMB(proportion.eaten ~ 1, data = censorsub, ziformula = ~1,na.action = "na.fail")
ZIglm10 <- glmmTMB(proportion.eaten ~ Temperature, data = censorsub, ziformula = ~1,na.action = "na.fail")
ZIglm11 <- glmmTMB(proportion.eaten ~ Temperature*Period, data = censorsub, ziformula = ~1, family = ziGamma((link= "log")),na.action = "na.fail")
ZIglm12 <- glmmTMB(proportion.eaten ~ Temperature + Period, data = censorsub, ziformula = ~1, family = ziGamma((link= "log")),na.action = "na.fail")
ZIglm13 <- glmmTMB(proportion.eaten ~ Period, data = censorsub, ziformula = ~1, family = ziGamma((link= "log")),na.action = "na.fail")
ZIglm14 <- glmmTMB(proportion.eaten ~ 1, data = censorsub, ziformula = ~1, family = ziGamma((link= "log")),na.action = "na.fail")
ZIglm15 <- glmmTMB(proportion.eaten ~ Temperature, data = censorsub, ziformula = ~1, family = ziGamma((link= "log")),na.action = "na.fail")

ZIglm16 <- glmmTMB(proportion.eaten ~ Temperature*Period, data = censorsub, ziformula = ~Temperature, family = ziGamma((link= "inverse")),na.action = "na.fail")
ZIglm17 <- glmmTMB(proportion.eaten ~ Temperature + Period, data = censorsub, ziformula = ~Temperature, family = ziGamma((link= "inverse")),na.action = "na.fail")
ZIglm18 <- glmmTMB(proportion.eaten ~ Period, data = censorsub, ziformula = ~Temperature, family = ziGamma((link= "inverse")),na.action = "na.fail")
ZIglm19 <- glmmTMB(proportion.eaten ~ 1, data = censorsub, ziformula = ~Temperature, family = ziGamma((link= "inverse")),na.action = "na.fail")
ZIglm20 <- glmmTMB(proportion.eaten ~ Temperature, data = censorsub, ziformula = ~Temperature, family = ziGamma((link= "inverse")),na.action = "na.fail")
ZIglm21 <- glmmTMB(proportion.eaten ~ Temperature*Period, data = censorsub, ziformula = ~Temperature,na.action = "na.fail")
ZIglm22 <- glmmTMB(proportion.eaten ~ Temperature + Period, data = censorsub, ziformula = ~Temperature,na.action = "na.fail")
ZIglm23 <- glmmTMB(proportion.eaten ~ Period, data = censorsub, ziformula = ~Temperature,na.action = "na.fail")
ZIglm24 <- glmmTMB(proportion.eaten ~ 1, data = censorsub, ziformula = ~1,na.action = "na.fail")
ZIglm25 <- glmmTMB(proportion.eaten ~ Temperature, data = censorsub, ziformula = ~Temperature,na.action = "na.fail")
ZIglm26 <- glmmTMB(proportion.eaten ~ Temperature*Period, data = censorsub, ziformula = ~Temperature, family = ziGamma((link= "log")),na.action = "na.fail")
ZIglm27 <- glmmTMB(proportion.eaten ~ Temperature + Period, data = censorsub, ziformula = ~Temperature, family = ziGamma((link= "log")),na.action = "na.fail")
ZIglm28 <- glmmTMB(proportion.eaten ~ Period, data = censorsub, ziformula = ~Temperature, family = ziGamma((link= "log")),na.action = "na.fail")
ZIglm29 <- glmmTMB(proportion.eaten ~ 1, data = censorsub, ziformula = ~Temperature, family = ziGamma((link= "log")),na.action = "na.fail")
ZIglm30 <- glmmTMB(proportion.eaten ~ Temperature, data = censorsub, ziformula = ~Temperature, family = ziGamma((link= "log")),na.action = "na.fail")

#mod 6 and 8 are the best
mod1 <- glm(proportion.eaten ~ Temperature*Period, data = censorsub)
mod2 <- glm(proportion.eaten ~ Temperature + Period, data = censorsub)
mod3 <- glm(proportion.eaten ~ Temperature, data = censorsub)
mod4 <- glm(proportion.eaten ~ Period, data = censorsub)
mod5 <- glm(proportion.eaten ~ 1, data = censorsub)
censor_nozero <- censorsub
censor_nozero$proportion.eaten <- ifelse(censor_nozero$proportion.eaten <= 0, 0.001, censor_nozero$proportion.eaten)
mod6 <- glm(proportion.eaten ~ Temperature*Period, family = Gamma(link = "log"), data = censor_nozero)
mod7 <- glm(proportion.eaten ~ Temperature + Period, family = Gamma(link = "log"), data = censor_nozero)
mod8 <- glm(proportion.eaten ~ Temperature, family = Gamma(link = "log"), data = censor_nozero)
mod9 <- glm(proportion.eaten ~ Period, family = Gamma(link = "log"), data = censor_nozero)
mod10 <- glm(proportion.eaten ~ 1, family = Gamma(link = "log"), data = censor_nozero)
mod11 <- glm(proportion.eaten ~ Temperature*Period, family = Gamma(link = "inverse"), data = censor_nozero)
mod12 <- glm(proportion.eaten ~ Temperature + Period, family = Gamma(link = "inverse"), data = censor_nozero)
mod13 <- glm(proportion.eaten ~ Temperature, family = Gamma(link = "inverse"), data = censor_nozero)
mod14 <- glm(proportion.eaten ~ Period, family = Gamma(link = "inverse"), data = censor_nozero)
mod15 <- glm(proportion.eaten ~ 1, family = Gamma(link = "inverse"), data = censor_nozero)

AIC(ZIglm1, ZIglm2, ZIglm3, ZIglm4, ZIglm5, ZIglm6, ZIglm7, ZIglm8, ZIglm9, ZIglm10, ZIglm11, ZIglm12, ZIglm13, ZIglm14, ZIglm15, ZIglm16, ZIglm17, ZIglm18, ZIglm19, ZIglm20, ZIglm21, ZIglm22, ZIglm23, ZIglm24, ZIglm25, ZIglm26, ZIglm27, ZIglm28, ZIglm29, ZIglm30)
AIC(mod1, mod2, mod3, mod4, mod5, mod6, mod7, mod8, mod9, mod10, mod11, mod12, mod13, mod14, mod15)

#fit is poor among the top models that AIC spits back...
best.glm.mod1 <- glm(proportion.eaten ~ Temperature*Period, family = Gamma(link = "log"), data = censor_nozero)
best.glm.mod2 <- glm(proportion.eaten ~ Temperature, family = Gamma(link = "log"), data = censor_nozero)
ZIglm.resids <- simulateResiduals(best.glm.mod1)
plot(ZIglm.resids)
ZIglm.resids <- simulateResiduals(best.glm.mod2)
plot(ZIglm.resids)

#models without gamma are ranked lower in AIC; however, they have 
best.glm.mod3 <- glm(proportion.eaten ~ Temperature*Period, data = censor_nozero)
best.glm.mod4 <- glm(proportion.eaten ~ Temperature, data = censor_nozero)
par(mfrow = c(2,2))
plot(best.glm.mod3)
plot(best.glm.mod4)

#model 2 fits well except for (what I assume) temperature 26 C - NaN produced all around for summaries, need an alternative
best.ZI.mod1 <- glmmTMB(proportion.eaten ~ Temperature*Period, data = censorsub, ziformula = ~1,na.action = "na.fail")
best.ZI.mod2 <- glmmTMB(proportion.eaten ~ Temperature, data = censorsub, ziformula = ~1,na.action = "na.fail")
ZIglm.resids <- simulateResiduals(best.mod1)
plot(ZIglm.resids)
ZIglm.resids <- simulateResiduals(best.mod2)
plot(ZIglm.resids)

ZIglm.resids <- simulateResiduals(ZIglm10)
plot(ZIglm.resids)
summary(ZIglm10)
#Green crab - Normal -----------------------------------------------------------
censorsub <- subset(finalEatCensor, finalEatCensor$Species.x == "CM")
hist(censorsub$proportion.eaten)

#tie between 3 models
all.mod <- glm(proportion.eaten ~ Temperature*Period, data = censorsub, na.action = "na.fail")
dredge(all.mod)

#model 3 is the best
censorsub$proportion.eaten <- ifelse(censorsub$proportion.eaten <= 0, .001, censorsub$proportion.eaten)
all.mod.mixed1 <- glm(proportion.eaten ~ Temperature, family = Gamma(link = "inverse"), data = censorsub, na.action = "na.fail")
all.mod.mixed2 <- glm(proportion.eaten ~ Temperature, family = Gamma(link = "log"), data = censorsub, na.action = "na.fail")
all.mod.mixed3 <- glm(proportion.eaten ~ Temperature, data = censorsub, na.action = "na.fail")
all.mod.mixed4 <- glm(proportion.eaten ~ Temperature*Period, family = Gamma(link = "inverse"), data = censorsub, na.action = "na.fail")
all.mod.mixed5 <- glm(proportion.eaten ~ Temperature*Period, family = Gamma(link = "log"), data = censorsub, na.action = "na.fail")
all.mod.mixed6 <- glm(proportion.eaten ~ Temperature*Period, data = censorsub, na.action = "na.fail")
all.mod.mixed7 <- glm(proportion.eaten ~ Temperature+Period, family = Gamma(link = "inverse"), data = censorsub, na.action = "na.fail")
all.mod.mixed8 <- glm(proportion.eaten ~ Temperature+Period, family = Gamma(link = "log"), data = censorsub, na.action = "na.fail")
all.mod.mixed9 <- glm(proportion.eaten ~ Temperature+Period, data = censorsub, na.action = "na.fail")
AIC(all.mod.mixed2, all.mod.mixed1, all.mod.mixed3, all.mod.mixed4, all.mod.mixed5, all.mod.mixed6, all.mod.mixed7, all.mod.mixed8, all.mod.mixed9)

#model 3 is a good fit!
par(mfrow = c(2,2))
plot(all.mod.mixed3)
plot(fitted(all.mod.mixed3), residuals(all.mod.mixed3))
abline(h=0, col="red")
hist(residuals(all.mod.mixed3))

summary(all.mod.mixed3)

#Shore crab - skew/normal ------------------------------------------------------
censorsub <- subset(finalEatCensor, finalEatCensor$Species.x == "HS")
hist(censorsub$proportion.eaten)

#dredge function returns that period is not important to the model, so I'll leave it out
all.mod.mixed <- glm(proportion.eaten ~ Temperature*Period, data = censorsub, na.action = "na.fail")
dredge(all.mod.mixed)

censorsub$proportion.eaten <- ifelse(censorsub$proportion.eaten <= 0, .001, censorsub$proportion.eaten)
#model 3 is the best and the glm fits well
all.mod.mixed1 <- glm(proportion.eaten ~ Temperature, family = Gamma(link = "inverse"), data = censorsub, na.action = "na.fail")
all.mod.mixed2 <- glm(proportion.eaten ~ Temperature, family = Gamma(link = "log"), data = censorsub, na.action = "na.fail")
all.mod.mixed3 <- glm(proportion.eaten ~ Temperature, data = censorsub, na.action = "na.fail")
all.mod.mixed4 <- glm(proportion.eaten ~ Temperature*Period, family = Gamma(link = "inverse"), data = censorsub, na.action = "na.fail")
all.mod.mixed5 <- glm(proportion.eaten ~ Temperature*Period, family = Gamma(link = "log"), data = censorsub, na.action = "na.fail")
all.mod.mixed6 <- glm(proportion.eaten ~ Temperature*Period, data = censorsub, na.action = "na.fail")
AIC(all.mod.mixed1, all.mod.mixed2, all.mod.mixed3, all.mod.mixed4, all.mod.mixed5, all.mod.mixed6)

#best AIC model and great fit
par(mfrow = c(2,2))
plot(all.mod.mixed3)
plot(fitted(all.mod.mixed3), residuals(all.mod.mixed3))
abline(h=0, col="red")
hist(residuals(all.mod.mixed3))

#both indicate temperature slope is non 0
summary(all.mod.mixed3)




```



EXTRAS

#### Amount of who did not eat by species and trial

```{R, echo = FALSE, warning = FALSE}
all$eaten <- factor(all$eaten, levels = c("YES", "NO"))
all$Species.x <- factor(all$Species.x, levels = c("HS", "CM", "CI"))
ggplot(all, aes(x = Temperature, fill = eaten)) + geom_bar(stat = "count") + facet_wrap(~Species.x)+
  scale_fill_manual(values = c("YES" = "darkolivegreen4",
                                "NO"="darkred"))+ggtitle("Amount of Times Individuals did not eat")+xlab("Trial Temperature") + ylab("Count")

#Amount of those who are still eating vs not eating
all$still_eating <- factor(all$still_eating, leve = c("NO", "YES"))
ggplot(all, aes(x = Temperature, fill = still_eating))+ geom_bar(stat = "count") + facet_wrap(~Species.x)+
  ggtitle("Amount of those who are still eating vs not eating") +
  scale_fill_manual(values = c("YES" = "darkolivegreen4",
                                "NO"="darkred"))+xlab("Trial Temperature") + ylab("Count")
```

### Schedule

```{R echo = FALSE}
date_list <- data.frame(date = NA, trial = NA, period = NA)
date_list$date <- as.Date(date_list$date)
trial_list <- list("18", "20", "22", "24", "26")

for(a in 1:2){
  for(i in 1:length(trial_list)){
  holddf <- subset(original, original$Temperature == trial_list[i] & original$Period == a)
  dates <- unique(holddf$Date.x)
  for(j in 1:length(dates)){
    date_list[nrow(date_list) + 1,] <- list(dates[j], trial_list[i], a)
  }
}
}
date_list <- na.omit(date_list)

date_list$trial <- unlist(date_list$trial)
date_list$weekday <- weekdays(date_list$date)
date_list$month <- month(date_list$date)
date_list$day <- format(as.Date(date_list$date,format="%y-%m-%d"), format = "%d")

date_list$weekday <- as.factor(date_list$weekday)
date_list$month <- as.factor(date_list$month)
date_list$day <- as.factor(date_list$day)

date_list <- na.omit(date_list)
date_list$day <- as.numeric(as.character(date_list$day))  # "09" → 9
date_list$day <- factor(date_list$day, levels = 1:31)

ggplot(date_list, aes(x = day, y = as.factor(trial), fill = as.factor(period))) +
  geom_tile(color = "black",alpha = 0.5) +
  facet_wrap(~ month, ncol = 1) +
  coord_fixed() +
  scale_x_discrete(drop = FALSE)+
  ggtitle("Trial schedule for the Summer of 2025")+
  xlab("Day")+
  ylab("Trial Temperature")+ guides(fill=guide_legend(title="Period")) + theme_classic() +
  scale_fill_manual(values = c("1" = "red4",
                                "2"="blue4"))
```

## Outlier Search

```{r, fig.show="hold", out.width="50%", echo = FALSE, warning = FALSE}
ggplot(all, aes(y = CL, color = Species.x)) + geom_boxplot() +
  ggtitle("Species Comparison between Carapace Length")+
  scale_color_manual(values = c("CI" = "darkorange",
                                "CM"="darkgreen",
                                "HS"="darkred"))

ggplot(all, aes(y = proportion.eaten, color = Species.x)) + geom_boxplot() +
  ggtitle("Species Comparison Between Proportion Eaten")+
  scale_color_manual(values = c("CI" = "darkorange",
                                "CM"="darkgreen",
                                "HS"="darkred"))

# Carapace Length and Wet Weight Comparison between species

ggplot(master, aes(x = WW, y = CL, color = Species)) + geom_point()+
  ggtitle("Carapace Length and Wet Weight Comparison between species")+
  scale_color_manual(values = c("Irroratus" = "darkorange",
                                "Carcinus"="darkgreen",
                                "Hemigrapsus"="darkred"))


#There is an outlier who is CM 176 - I am willing to throw this individual out since he is the only one of it's kind
#all <- subset(all, all$ID != "CM176")
outliers <- list(c(ID = "CM176"))

#Pretty normal - looking good
# Checking for Outliers and that wet weight is normal
holddf <- subset(master, master$Species == "Irroratus")
ggplot(holddf, aes(x = WW)) + geom_histogram(binwidth = 25, fill = "darkorange", color = "black") + facet_wrap(~Species, scales = "free") + ggtitle("Wet weight for Cancer")

holddf <- subset(master, master$Species == "Carcinus")
ggplot(holddf, aes(x = WW)) + geom_histogram(binwidth = 15, fill = "darkgreen", color = "black") + facet_wrap(~Species, scales = "free") + ggtitle("Wet weight for Carcinus")

holddf <- subset(master, master$Species == "Hemigrapsus")
ggplot(holddf, aes(x = WW)) + geom_histogram(binwidth = 1, fill = "darkred", color = "black") + facet_wrap(~Species, scales = "free") + ggtitle("Wet weight for Hemigrapsus")

#We can check if there are differences in weight weight between Species and Trial through some quick models
holddf <- subset(master, master$Species == "Irroratus")
mod <- glm(holddf$WW ~ holddf$Trial * holddf$Period)
emm <- emmeans(mod, ~ Trial*Period)
pairs_data <- pairs(emm)
pairs_data

holddf <- subset(master, master$Species == "Carcinus")
mod <- glm(holddf$WW ~ holddf$Trial * holddf$Period)
emm <- emmeans(mod, ~ Trial*Period)
pairs_data <- pairs(emm)
pairs_data

holddf <- subset(master, master$Species == "Hemigrapsus")
mod <- glm(holddf$WW ~ holddf$Trial * holddf$Period)
emm <- emmeans(mod, ~ Trial*Period)
pairs_data <- pairs(emm)
pairs_data

#NO DIFFERENCE FOR SIZE BETWEEN TRIAL AND PERIOD FOR EACH SPECIES WOOOOOOOO

#Looking more specifically at each outlier for weight to see if they acted as expected or not. Checking in on the outlier for rock and hemi
#CI117
holddf <- subset(all, all$ID == "CI117")
ggplot(holddf, aes(x = Date.x, y = proportion.eaten)) + geom_point() + geom_smooth(method = "loess", se = FALSE) + ggtitle("Proportion eaten by CI117 in 18 C in period 2")

#HS92
holddf <- subset(all, all$ID == "HS92")
ggplot(holddf, aes(x = Date.x, y = proportion.eaten)) + geom_point() + geom_smooth(method = "loess", se = FALSE) + ggtitle("Proportion eaten by HS92 in 26 C in period 2")

#HS92
holddf <- subset(all, all$ID == "CM176")
ggplot(holddf, aes(x = Date.x, y = proportion.eaten)) + geom_point() + geom_smooth(method = "loess", se = FALSE) + ggtitle("Proportion eaten by CM176 in 20 C in period 2")

# Plotting the proportion eaten to see outliers and normality
ggplot(all, aes(x = proportion.eaten, fill = Species.x)) + geom_histogram(binwidth = 0.01) + facet_wrap(~Species.x, scales = "free") + ggtitle("Proportion eaten by species")+
  scale_fill_manual(values = c("CI" = "darkorange",
                                "CM"="darkgreen",
                                "HS"="darkred"))
#everyone looks normal except for hemigrapsus which has some trialing end points
```

### Size effect on Consumption

```{R echo = FALSE}
ggplot(all, aes(x = WW, y = proportion.eaten, color = Species.x)) + geom_point() +geom_smooth(aes(x = WW, y = proportion.eaten,group = Species.x),   
    color = "black",    
    se = FALSE,
    inherit.aes = FALSE,
    method = "lm")+  
  scale_x_log10() +
  scale_color_manual(values = c("CI" = "darkorange",
                                "CM"="darkgreen",
                                "HS"="darkred")) + ylab("Amount Eaten (proportionally)") +xlab("WW (log scale)") +ggtitle("Amount Eaten by Weight") + labs(color = "Species")
```

### Regraphing Hemi and Carcinus without those who didn't eat (prediction of molt)

```{R, echo=FALSE,results='hide',fig.keep='all'}
summary_df <- EatDF %>%
  group_by(Species.x, Temperature, Period, still_eating) %>%
  summarise(
    mean = mean(proportion.eaten),
    se = sd(proportion.eaten) / sqrt(n())
  )
summary_df <- subset(summary_df, summary_df$still_eating == "NO")

ggplot(summary_df, aes(x = as.numeric(Temperature), y = mean, color = Species.x)) + geom_point(position = position_dodge(width = 0.3))+
  scale_color_manual(values = c("HS" = "darkred",
                                 "CM" = "darkgreen",
                                 "CI" = "darkorange"))+
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se),
                width = 0.1, size = 0.8, position = position_dodge(width = 0.3)) +
  geom_smooth(method = "loess", se = FALSE)+ scale_y_log10()+
  ylab("Logged Mean of Proportion Eaten")+
  xlab("Trial Temperature") + labs(color = "Species")+
  ggtitle("Proportion Consumed over Trial Temperature")
```

### Graphing the Husbandry Logs

```{R, echo = FALSE, warning = FALSE}
savedhus <- husbandry
husbandry <- savedhus
husbandry$Date <- as.Date(husbandry$Date, format="%m/%d/%Y")
ggplot(husbandry, aes(x = Date, y = Temperature, color = Trial)) + geom_point() + facet_grid(Period~System)+
  scale_y_continuous(breaks = c(16, 18, 20, 22, 24, 26, 28))+ggtitle("Temperature Records for Each System and Trial") + 
  scale_color_manual(values = c("18"= "yellow",
                               "20" = "#fecc5c",
                               "22" = "#fd8d3c",
                               "24" ="#f03b20",
                               "26" = "#bd0026")) +theme_dark()
```

### Graphing Crab mass before and after the experiment

```{R, echo=FALSE,results='hide',fig.keep='all'}
ID_list <- list()
trial_list <- list()
period_list <- list()
species_list <- list()
weight_before <- list()
weight_after <- list()

for(i in 1:nrow(master)){
  if(master$ID[i] %in% deathMeta$ID){
    
  }
  else{
    ID_list <- append(ID_list, master$ID[i])
    trial_list <- append(trial_list, master$Trial[i])
    period_list <- append(period_list, master$Period[i])
    species_list <- append(species_list, master$Species[i])
    weight_before <- append(weight_before, master$WW[i])
    weight_after <- append(weight_after, checkout$WW[which(checkout$ID == master$ID[i])])
  }
}

weight_df <- data.frame(
  ID = unlist(I(ID_list)),
  Trial = unlist(I(trial_list)),
  Period = unlist(I(period_list)),
  species = unlist(I(species_list)),
  weight_before = unlist(I(weight_before)),
  weight_after = unlist(I(weight_after))
)

weight_df$dif <- as.numeric(weight_df$weight_after) - as.numeric(weight_df$weight_before)

#CM139
#CM141

weight_df <- subset(weight_df, weight_df$ID != "CM139")
weight_df <- subset(weight_df, weight_df$ID != "CM141")

ggplot(weight_df, aes(x = as.factor(species), y = as.numeric(dif), fill = species)) + geom_boxplot(na.rm = TRUE)+
  scale_fill_manual(values = c("Carcinus" = "darkgreen",
                               "Hemigrapsus" = "darkred",
                               "Irroratus" = "darkorange"))+
  geom_hline(yintercept = 0, color = "red", linetype = "dashed", size = 0.5) + ggtitle("Weight change of each species over the whole experiment")+
  facet_wrap(~Trial)+xlab("Species") + ylab("Weight Change (g)")
```