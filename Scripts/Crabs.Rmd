# Chance's Second Thesis Chapter: Understand Thermal Niche from Consumption TPCs

Made by Chance Yan Last Edit:

**Question:** Is there thermal niche overlap or complementary in consumption among the predatory crabs of the Gulf of Maine?

**Hypothesis:** There is thermal niche complementary between the crab predators. 

**Null Hypothesis:** There is thermal niche overlap between the crab predators.

**Predictions:**

-   Prediction 1: The asian shore crab will have the highest consumption TPC/thermal niche compared to green crabs and cancer crabs. Followed by green crabs having the second highest TPC/thermal niche. Meanwhile, cancer crabs (*Cancer borealis* preferred, but *Cancer irroratus* backup - more on this later)

-   Prediction 2:There is no difference in consumption TPC between green crabs, asian shore crabs, and cancer crabs. 

-   Prediction 3: There is some overlap between 2 of the species, but not the last one. 

**Experimental Design:**

2 Systems (2 possible temperatures at a time), 5 temperature regimes (minimum to map out a TPC), 3 species, 6 repetitions. We can only fit 18 individuals in each system.

6 reps \* 3 species \* 5 temperature regimes \* 2 temporal blocks = 180 crabs\

## Data Processing

```{R, include = FALSE, warning = FALSE}
library(ggplot2)
library(lubridate)
library(hms)
library(dplyr)
library(emmeans)
setwd("/Users/chanceyan/Documents/R/ThesisCrab/Data")
crabdata <- read.csv("Feeding.csv", h=T)
death <- read.csv("DeathCount.csv", h=T)
master <- read.csv("Master.csv", h=T)
deathMeta <- read.csv("Death.csv", h=T)
husbandry <- read.csv("Husbandry.csv", h=T)
checkout <- read.csv("CheckOut.csv", h=T)
```

#### Cleaning up data for use

We need to clean up the data first to use it. What I did...

-   Created a new value for each crab feeding point (Food in - Food out to get total eaten). Then calculated proportion eaten by taking the amount eaten and diving it by the body weight of the crab.

-   I pushed all those who did not eat to 0 (noted who didn't eat via bite marks, but didn't explicitly write 0 still).

-   Removed feeding points where individuals ate everything and those who died.

-   Removed those who molted during the experiment

-   Removed the mackerel and mussel feeding (since they were a one off feeding and did not measure well)

```{R include = FALSE, warning = FALSE}
crabdata$FoodIn <- as.numeric(as.character(crabdata$FoodIn))
crabdata$FoodOut <- as.numeric(as.character(crabdata$FoodOut))

#removing rows that contain no data or recorded incorrectly
for(i in 1:nrow(crabdata)){
  if(!is.numeric(crabdata[i,4])){
    crabdata <- crabdata[-i,]
  }
  if(!is.numeric(crabdata[i,6])){
    crabdata <- crabdata[-i,]
  }
}

#Creating number IDs for each crab based of their IDs so it's easier to loop through with future code. Also I'm adding a total eaten by proportion column, so we have a standard metric to compare by.
for(i in 1:36){
  master$num[[i]] <- substr(master$ID[[i]], 3,5)
}
#WE NEED TO ACCOUNT FOR THOSE WHO GOT REPLCED AND CHANGE THEIR WEIGHT
crabdata$amount.eaten <- crabdata$FoodIn-crabdata$FoodOut
all <- merge(crabdata, master, by="ID")

#Changing date column into a date data type, so that R can read it as a Date.
all$Date.x = as.Date(all$Date.x, format = "%m/%d/%Y")
deathMeta$Date = as.Date(deathMeta$Date, format = "%m/%d/%Y")

#run through the feed data
for(i in 1:nrow(all)){
  #if the individual is marked on the death metasheet then that means they may have been replaced (or not)
  if(any(deathMeta$ID == all$ID[i])){
    #If the ID is on the death metasheet, check which row it's on and see if it's been replaced or not
    row_dat <- deathMeta[deathMeta$ID == all$ID[i],]
    #the value has been replaced!
    if(row_dat$Replaced == "Y"){
      #Only replace if date is after the death date
      if(all$Date.x[i] >= row_dat$Date){
        all$proportion.eaten[i] <- all$amount.eaten[i] / row_dat$ReplacedWeight
        all$WW[i] <- row_dat$ReplacedWeight
      }
      else{
        all$proportion.eaten[i] <- (all$amount.eaten[i] / all$WW[i])
      }
    }
    #If not replaced continue as usual
    else{
      all$proportion.eaten[i] <- (all$amount.eaten[i] / all$WW[i])
    }
  }
  #If not on death sheet continue as usual
  else{
    all$proportion.eaten[i] <- (all$amount.eaten[i] / all$WW[i])
  }
}

#Making all those who did not eat to 0
#Maybe don't need? Blank out for now "DE", keep other
for(i in 1:nrow(all)){
  #if(grepl("DE", all$Notes.x[i], fixed = TRUE)){
  #  all$proportion.eaten[i] = 0
  #}
  if(grepl("AE", all$Notes.x[i], fixed = TRUE)){
    all <- all[-i, ] 
  }
  if(grepl("DI", all$Notes.x[i], fixed = TRUE)){
    all <- all[-i, ] 
  }
  if(is.na(all$amount.eaten[i])){
    all <- all[-i,]
  }
  else{
    #code if amount eaten was less than 0 make it 0
    #if(all$amount.eaten[i] < 0){
    #  all$proportion.eaten[i] = 0
    #}
  }
}

original <- all

#removing mussel and mackerel feed
all <- subset(all, all$Food != "Mussels")
all <- subset(all, all$Food != "Mackerel")


#saving those who molted in an original dataset
original_molted <- all
original_molted$molted <- ifelse(grepl("ME", original_molted$Notes.x, fixed = TRUE), "YES", "NO")

#Removing those that molted
array <- c()

for(i in 1:nrow(all)){
  if(grepl("ME", all$Notes.x[i], fixed = TRUE)){
    ID_value <- all$ID[i]
    for(j in 1:nrow(all)){
      if(all$ID[j] == ID_value){
        array <- c(array, j)
      }
    }
  }
}

all <- all[-array,]
array <- c()

#Removing these dates because feeding was not following a strict schedule (fed two days back to back)
all <- subset(all, !(WeekNum == 1 & Trial.x == 16))
all <- subset(all, !(WeekNum == 1 & Trial.x == 22 & Period == 1))

holddf <- subset(all, Trial.x == 22)

#Changing trials 16 and 18 to be one.
all$Trial.x <- ifelse(all$Trial.x == "16", "18", all$Trial.x)
original$Trial.x <- ifelse(original$Trial.x == "16", "18", original$Trial.x)
master$Trial <- ifelse(master$Trial == "16", "18", master$Trial)

#Here, I am marking all those who did not eat
EatDF <- subset(all, grepl("DE", all$Notes.x, fixed = TRUE))

#Making a new column indicating whether the animal ate or not
eaten_row <- list()
for(i in 1:nrow(all)){
  if(grepl("DE", all$Notes.x[i], fixed = TRUE)){
    eaten_row <- c(eaten_row, "NO")
  }
  else{
    eaten_row <- c(eaten_row, "YES")
  }
}
all$eaten <- eaten_row

#Making a column if the animal was still eating or not
all$still_eating <- ifelse(grepl("SE", all$Notes.x, fixed = TRUE), "YES", "NO")

inBucket <- list()
#total time of food in bucket
all$TimeInStrip <- as.POSIXct(paste(all$Date.x, all$TimeIn), format = "%Y-%m-%d %I:%M:%S %p")
all$TimeOutStrip <- as.POSIXct(paste(all$Date.x, all$TimeOut), format = "%Y-%m-%d %I:%M:%S %p")
#all$TimeOut <- hm(all$TimeOut)
for(i in 1:nrow(all)){
  hour <- as.numeric(format(all$TimeInStrip[i], "%H"))
  if(hour < 8){
    #print(all$TimeInStrip[i])
    all$TimeInStrip[i] <- all$TimeInStrip[i] + 12 * 60 * 60
  }
  hour <- as.numeric(format(all$TimeOutStrip[i], "%H"))
  if(hour < 8){
    #print(all$TimeInStrip[i])
    all$TimeOutStrip[i] <- all$TimeOutStrip[i] + 12 * 60 * 60
  }
  
  inBucket <- append(inBucket, as.numeric(difftime(all$TimeOutStrip[i], all$TimeInStrip[i], units = "mins")))
}

all$timeInBucket <- inBucket

#because we removed the first week from trials 1 and 2, to get the final week, I'll just subtract one from the value to line it up so that week 4 equals week 3 and make it easier for me to graph

all$WeekNum <- ifelse((all$Trial.x == "18" & all$WeekNum == 2 & all$Period == 1), "1", all$WeekNum)
all$WeekNum <- ifelse((all$Trial.x == "18" & all$WeekNum == 3 & all$Period == 1), "2", all$WeekNum)
all$WeekNum <- ifelse((all$Trial.x == "18" & all$WeekNum == 4 & all$Period == 1), "3", all$WeekNum)

all$WeekNum <- ifelse((all$Trial.x == "22" & all$WeekNum == 2 & all$Period == 1), "1", all$WeekNum)
all$WeekNum <- ifelse((all$Trial.x == "22" & all$WeekNum == 3 & all$Period == 1), "2", all$WeekNum)
all$WeekNum <- ifelse((all$Trial.x == "22" & all$WeekNum == 4 & all$Period == 1), "3", all$WeekNum)

#I just want to see what removing those who did not eat (in order to predict who was molting...) will do to hemi and carcinus
#making a list of those who did not eat for carcinus and hemi
DE_df <- list()
unique_indiv <- list()
holddf <- subset(all, all$Species.x == "HS" | all$Species.x == "CM")
DE_df <- ifelse(grepl("DE", holddf$Notes.x, fixed = TRUE), holddf$ID, NA)
unique_indiv <-  unique(na.omit(DE_df))

EatDF <- all

for(i in 1:length(unique_indiv)){
  EatDF <- subset(EatDF, EatDF$ID != unique_indiv[i])
}

#husbandry sheet prep
husbandry <- subset(husbandry, husbandry$Trial != "NONE")
```

## Data Exploration

### Basic information on the dataset (Post Data Modifications)

```{r echo = FALSE, warning = FALSE}
c <- tapply(master$ID, list(master$Species, master$Trial), FUN = length)

b <- tapply(all$proportion.eaten, list(all$Species.x, all$Trial.x), FUN = length)

a <- tapply(all$CL, list(all$Species.x, all$Trial.x), FUN = mean)

library(knitr)
kable(c, caption = "Sample size for each species, trial")
kable(b, caption = "Sample size for each feeding trial")
kable(a, caption = "Average Carapace Length for each species, trial")
```

Hemigrapsus at 26 C is much smaller because I removed a lot of those who molted

### Death Count Among Species and Trial (data includes those who died (prvious feed points before death))

```{R, echo = FALSE, warning = FALSE}
#Making a graph for counts
death$Species <- factor(death$Species, levels = c("HS", "CM", "CI"))
ggplot(death, aes(x = as.factor(Trial), y = Count, fill = Life)) + facet_wrap(~Species) + geom_bar(stat='identity')+
  scale_fill_manual(values = c("ALIVE" = "darkolivegreen4",
                                "DEAD"="darkred"))+
  xlab("Trial Temperature")+ggtitle("The Amount of Crabs that Died in the Experiment")

#make a percentage alive column.
library(dplyr)

result <- death %>%
  group_by(Species, Trial) %>%
  summarise(
    alive = sum(Count[Life == "ALIVE"]),
    total = sum(Count),
    prop_alive = alive / total,
    .groups = "drop"
  )

library(ggplot2)

ggplot(result, aes(x = Species, y = prop_alive, fill = factor(Trial))) +
  geom_col(position = "dodge") +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    y = "Proportion Alive",
    fill = "Trial"
  ) +
  theme_minimal()

result$dead <- result$total - result$alive

m.null <- glm(cbind(dead, total - dead) ~ 1, family = binomial, data = result)
m.species <- glm(cbind(dead, total - dead) ~ Species, family = binomial, data = result)
m.trial <- glm(cbind(dead, total - dead) ~ as.factor(Trial), family = binomial, data = result)
m.add <- glm(cbind(dead, total - dead) ~ Species + as.factor(Trial), family = binomial, data = result)
m.inter <- glm(cbind(dead, total - dead) ~ Species * Trial,
    family = binomial,
    data = result)

models <- list()
models[[1]] <- glm(cbind(dead, total - dead) ~ 1, family = binomial, data = result)
models[[2]] <- glm(cbind(dead, total - dead) ~ Species, family = binomial, data = result)
models[[3]] <- glm(cbind(dead, total - dead) ~ as.factor(Trial), family = binomial, data = result)
models[[4]] <- glm(cbind(dead, total - dead) ~ Species + as.factor(Trial), family = binomial, data = result)
models[[5]] <- glm(cbind(dead, total - dead) ~ Species * Trial,
    family = binomial,
    data = result)

names(models) <- c("null","species","trial","add","inter")

library(AICcmodavg)
aictab(models)

plot(m.inter)
plot(m.species)

#heyyyy, interaction model looks pretty normal for residuals
histogram(residuals(m.inter))
#meanwhile, species model doesn't look as normal
histogram(residuals(m.species))
```

*Cancer irroratus* have the highest death count among all 3 species with *Hemigrapsus* having none and *Carcinus meanus* only having two death counts. Across trials with *Cancer irroratus*, the higher the trial temperature the more deaths there are as well.

#### Amount of who did not eat by species and trial

```{R, echo = FALSE, warning = FALSE}
all$eaten <- factor(all$eaten, levels = c("YES", "NO"))
all$Species.x <- factor(all$Species.x, levels = c("HS", "CM", "CI"))
ggplot(all, aes(x = Trial.x, fill = eaten)) + geom_bar(stat = "count") + facet_wrap(~Species.x)+
  scale_fill_manual(values = c("YES" = "darkolivegreen4",
                                "NO"="darkred"))+ggtitle("Amount of Times Individuals did not eat")+xlab("Trial Temperature") + ylab("Count")

#Amount of those who are still eating vs not eating
all$still_eating <- factor(all$still_eating, leve = c("NO", "YES"))
ggplot(all, aes(x = Trial.x, fill = still_eating))+ geom_bar(stat = "count") + facet_wrap(~Species.x)+
  ggtitle("Amount of those who are still eating vs not eating") +
  scale_fill_manual(values = c("YES" = "darkolivegreen4",
                                "NO"="darkred"))+xlab("Trial Temperature") + ylab("Count")
```

## Outlier Search

```{r, fig.show="hold", out.width="50%", echo = FALSE, warning = FALSE}
ggplot(all, aes(y = CL, color = Species.x)) + geom_boxplot() +
  ggtitle("Species Comparison between Carapace Length")+
  scale_color_manual(values = c("CI" = "darkorange",
                                "CM"="darkgreen",
                                "HS"="darkred"))

ggplot(all, aes(y = proportion.eaten, color = Species.x)) + geom_boxplot() +
  ggtitle("Species Comparison Between Proportion Eaten")+
  scale_color_manual(values = c("CI" = "darkorange",
                                "CM"="darkgreen",
                                "HS"="darkred"))

# Carapace Length and Wet Weight Comparison between species

ggplot(master, aes(x = WW, y = CL, color = Species)) + geom_point()+
  ggtitle("Carapace Length and Wet Weight Comparison between species")+
  scale_color_manual(values = c("Irroratus" = "darkorange",
                                "Carcinus"="darkgreen",
                                "Hemigrapsus"="darkred"))


#There is an outlier who is CM 176 - I am willing to throw this individual out since he is the only one of it's kind
#all <- subset(all, all$ID != "CM176")
outliers <- list(c(ID = "CM176"))

#Pretty normal - looking good
# Checking for Outliers and that wet weight is normal
holddf <- subset(master, master$Species == "Irroratus")
ggplot(holddf, aes(x = WW)) + geom_histogram(binwidth = 25, fill = "darkorange", color = "black") + facet_wrap(~Species, scales = "free") + ggtitle("Wet weight for Cancer")

holddf <- subset(master, master$Species == "Carcinus")
ggplot(holddf, aes(x = WW)) + geom_histogram(binwidth = 15, fill = "darkgreen", color = "black") + facet_wrap(~Species, scales = "free") + ggtitle("Wet weight for Carcinus")

holddf <- subset(master, master$Species == "Hemigrapsus")
ggplot(holddf, aes(x = WW)) + geom_histogram(binwidth = 1, fill = "darkred", color = "black") + facet_wrap(~Species, scales = "free") + ggtitle("Wet weight for Hemigrapsus")

#We can check if there are differences in weight weight between Species and Trial through some quick models
holddf <- subset(master, master$Species == "Irroratus")
mod <- glm(holddf$WW ~ holddf$Trial * holddf$Period)
emm <- emmeans(mod, ~ Trial*Period)
pairs_data <- pairs(emm)
pairs_data

holddf <- subset(master, master$Species == "Carcinus")
mod <- glm(holddf$WW ~ holddf$Trial * holddf$Period)
emm <- emmeans(mod, ~ Trial*Period)
pairs_data <- pairs(emm)
pairs_data

holddf <- subset(master, master$Species == "Hemigrapsus")
mod <- glm(holddf$WW ~ holddf$Trial * holddf$Period)
emm <- emmeans(mod, ~ Trial*Period)
pairs_data <- pairs(emm)
pairs_data

#NO DIFFERENCE FOR SIZE BETWEEN TRIAL AND PERIOD FOR EACH SPECIES WOOOOOOOO

#Looking more specifically at each outlier for weight to see if they acted as expected or not. Checking in on the outlier for rock and hemi
#CI117
holddf <- subset(all, all$ID == "CI117")
ggplot(holddf, aes(x = Date.x, y = proportion.eaten)) + geom_point() + geom_smooth(method = "loess", se = FALSE) + ggtitle("Proportion eaten by CI117 in 18 C in period 2")

#HS92
holddf <- subset(all, all$ID == "HS92")
ggplot(holddf, aes(x = Date.x, y = proportion.eaten)) + geom_point() + geom_smooth(method = "loess", se = FALSE) + ggtitle("Proportion eaten by HS92 in 26 C in period 2")

#HS92
holddf <- subset(all, all$ID == "CM176")
ggplot(holddf, aes(x = Date.x, y = proportion.eaten)) + geom_point() + geom_smooth(method = "loess", se = FALSE) + ggtitle("Proportion eaten by CM176 in 20 C in period 2")

# Plotting the proportion eaten to see outliers and normality
ggplot(all, aes(x = proportion.eaten, fill = Species.x)) + geom_histogram(binwidth = 0.01) + facet_wrap(~Species.x, scales = "free") + ggtitle("Proportion eaten by species")+
  scale_fill_manual(values = c("CI" = "darkorange",
                                "CM"="darkgreen",
                                "HS"="darkred"))
#everyone looks normal except for hemigrapsus which has some trialing end points
```

-   *Cancer irroratus* are larger than the other two species followed by *Carcinus meanus* then the smallest as *Hemigrapsus*.

-   The pattern is opposite when it comes to the amount they've eaten proportionally. So *Hemigrapsus* eats the most and *Cancer irroratus* eats the least.

There is a nice relationship between carapace length and wet weight. However, there was an outlier. I have thrown it out since it's the ONLY one so far off, but I have checked and data was entered correctly.

For each species on wet weight normality:

-Cancer: Pretty normal

-Green crab: Normal with some outliers

-Hemi: Normal with some outliers

It seems like Cancer crabs have a left leaning normality curve. Green crabs have a normal spread. Hemigrapsus have a left leaning curve as well. Unsure if this is even a valid graph because it's kind of what we expected if Cancer crabs are all tanking 0's due to it being too hot.

The only differences between size of trial and species is Hemigrapsus for Trial 26 between period 1 and 2 by about 3 grams of differnece. The other difference is for Trial 24 and 26 in period 2.

## Relationships

#### Food Effects

```{R, echo=FALSE,results='hide',fig.keep='all'}
#Looking at how much food gains or loses (not by being eaten, but by being in saltwater)
holddf <- subset(all, grepl("DE", all$Notes.x, fixed = TRUE))
ggplot(holddf, aes(x = Trial.x, y = proportion.eaten, fill = Species.x)) + geom_boxplot() + ggtitle("How much weight food gains or loses in Saltwater")+
  scale_fill_manual(values = c("CI" = "darkorange",
                                "CM"="darkgreen",
                                "HS"="darkred"))

# Food Type Effects on Proportion Eaten
ggplot(all, aes(x = all$Food, y = proportion.eaten, fill = Species.x)) + geom_boxplot()+ ggtitle("Food Type Effects on Proportion Eaten")+
  scale_fill_manual(values = c("CI" = "darkorange",
                                "CM"="darkgreen",
                                "HS"="darkred")) + xlab("Food Type") + ylab("Amount Eaten (proportionally)")

# Statistical Test to see if Squid is preferred over Clam for all 3 species
print("Hemigrapsus")
holddf <- subset(all, all$Species.x == "HS")
mod <- glm(holddf$proportion.eaten ~ holddf$Food)
emm <- emmeans(mod, ~ Food)
pairs_data <- pairs(emm)
pairs_data

print("Carcinus")
holddf <- subset(all, all$Species.x == "CM")
mod <- glm(holddf$proportion.eaten ~ holddf$Food)
emm <- emmeans(mod, ~ Food)
pairs_data <- pairs(emm)
pairs_data

print("Cancer")
holddf <- subset(all, all$Species.x == "CI")
mod <- glm(holddf$proportion.eaten ~ holddf$Food)
emm <- emmeans(mod, ~ Food)
pairs_data <- pairs(emm)
pairs_data
```

After running a t-test on these, it seems like green crabs and Hemigrapsus have a slight preference for squid rather than clam. Meanwhile Cancer crabs have no preference between the food types.

### Size effect on Consumption

```{R echo = FALSE}
ggplot(all, aes(x = WW, y = proportion.eaten, color = Species.x)) + geom_point() +geom_smooth(aes(x = WW, y = proportion.eaten,group = Species.x),   
    color = "black",    
    se = FALSE,
    inherit.aes = FALSE,
    method = "lm")+  
  scale_x_log10() +
  scale_color_manual(values = c("CI" = "darkorange",
                                "CM"="darkgreen",
                                "HS"="darkred")) + ylab("Amount Eaten (proportionally)") +xlab("WW (log scale)") +ggtitle("Amount Eaten by Weight") + labs(color = "Species")
```

### Schedule

```{R echo = FALSE}
date_list <- data.frame(date = NA, trial = NA, period = NA)
date_list$date <- as.Date(date_list$date)
trial_list <- list("18", "20", "22", "24", "26")

for(a in 1:2){
  for(i in 1:length(trial_list)){
  holddf <- subset(original, original$Trial.x == trial_list[i] & original$Period == a)
  dates <- unique(holddf$Date.x)
  for(j in 1:length(dates)){
    date_list[nrow(date_list) + 1,] <- list(dates[j], trial_list[i], a)
  }
}
}
date_list <- na.omit(date_list)

date_list$trial <- unlist(date_list$trial)
date_list$weekday <- weekdays(date_list$date)
date_list$month <- month(date_list$date)
date_list$day <- format(as.Date(date_list$date,format="%y-%m-%d"), format = "%d")

date_list$weekday <- as.factor(date_list$weekday)
date_list$month <- as.factor(date_list$month)
date_list$day <- as.factor(date_list$day)

date_list <- na.omit(date_list)
date_list$day <- as.numeric(as.character(date_list$day))  # "09" → 9
date_list$day <- factor(date_list$day, levels = 1:31)

ggplot(date_list, aes(x = day, y = as.factor(trial), fill = as.factor(period))) +
  geom_tile(color = "black",alpha = 0.5) +
  facet_wrap(~ month, ncol = 1) +
  coord_fixed() +
  scale_x_discrete(drop = FALSE)+
  ggtitle("Trial schedule for the Summer of 2025")+
  xlab("Day")+
  ylab("Trial Temperature")+ guides(fill=guide_legend(title="Period")) + theme_classic() +
  scale_fill_manual(values = c("1" = "red4",
                                "2"="blue4"))
```

Before we can analyze the proportion eaten, we have to understand if the acclimation worked... To do this, we'll bin each week by each other and calculate averages to compare.

### Checking for Acclimation

```{R echo = FALSE, warning = FALSE}

summary_df <- all %>%
  group_by(Species.x, Trial.x, Period, WeekNum) %>%
  summarise(
    mean = mean(proportion.eaten),
    se = sd(proportion.eaten) / sqrt(n())
  )

holddf <- subset(summary_df, summary_df$Species.x == "CI")

ggplot(holddf, aes(x = as.numeric(WeekNum), y = mean, color = as.factor(Period))) + 
  geom_point(position = position_dodge(width = 0.2)) + 
  facet_wrap(~Trial.x) +
  ggtitle("Proportion consumed over time for Period 1+2, Rock Crab") + 
  geom_smooth(method = "loess", se = FALSE)+
  scale_color_manual(values = c("1" = "red4","2"="blue4"))+
  xlab("Week Number") + 
  ylab("Amount Eaten (Proportionally)") + 
  labs(color = "Period")+
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), position = position_dodge(width = 0.2))

holddf <- subset(summary_df, summary_df$Species.x == "CM")

ggplot(holddf, aes(x = as.numeric(WeekNum), y = mean, color = as.factor(Period))) + 
  geom_point(position = position_dodge(width = 0.2)) + 
  facet_wrap(~Trial.x) +
  ggtitle("Proportion consumed over time for Period 1+2, Green Crab") + 
  geom_smooth(method = "loess", se = FALSE)+
  scale_color_manual(values = c("1" = "red4","2"="blue4"))+
  xlab("Week Number") + 
  ylab("Amount Eaten (Proportionally)") + 
  labs(color = "Period")+
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), position = position_dodge(width = 0.2))

holddf <- subset(summary_df, summary_df$Species.x == "HS")

ggplot(holddf, aes(x = as.numeric(WeekNum), y = mean, color = as.factor(Period))) + 
  geom_point(position = position_dodge(width = 0.2)) + 
  facet_wrap(~Trial.x) +
  ggtitle("Proportion consumed over time for Period 1+2, Asian Shore Crab") + 
  geom_smooth(method = "loess", se = FALSE)+
  scale_color_manual(values = c("1" = "red4","2"="blue4"))+
  xlab("Week Number") + 
  ylab("Amount Eaten (Proportionally)") + 
  labs(color = "Period")+
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), position = position_dodge(width = 0.2))
```

### Looking at the proportion eaten for each trial for each individual species (CI, CM, and HS)

```{R, echo=FALSE,results='hide',fig.keep='all'}
#only accounting for final week of trial
finalEat <- subset(all, all$WeekNum == 3)

summary_df <- finalEat %>%
  group_by(Species.x, Trial.x, Period) %>%
  summarise(
    mean = mean(proportion.eaten),
    se = sd(proportion.eaten) / sqrt(n())
  )

ggplot(summary_df, aes(x = as.numeric(Trial.x), y = mean, color = Species.x)) + geom_point(position = position_dodge(width = 0.3))+
  scale_color_manual(values = c("HS" = "darkred",
                                 "CM" = "darkgreen",
                                 "CI" = "darkorange"))+
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se),
                width = 0.1, size = 0.8, position = position_dodge(width = 0.3)) +
  geom_smooth(method = "loess", se = FALSE)+ scale_y_log10()+
  ylab("Logged Mean of Proportion Eaten")+
  xlab("Trial Temperature") + labs(color = "Species")+
  ggtitle("Proportion Consumed over Trial Temperature")

holddf <- subset(finalEat, finalEat$Species.x == "CI")
mod <- glm(holddf$proportion.eaten ~ as.factor(holddf$Trial.x))
summary(mod)
emm <- emmeans(mod, ~ as.factor(Trial.x))
pairs_data <- pairs(emm)
pairs_data

holddf <- subset(finalEat, finalEat$Species.x == "CM")
mod <- glm(holddf$proportion.eaten ~ as.factor(holddf$Trial.x))
summary(mod)
emm <- emmeans(mod, ~ as.factor(Trial.x))
pairs_data <- pairs(emm)
pairs_data

holddf <- subset(finalEat, finalEat$Species.x == "HS")
mod <- glm(holddf$proportion.eaten ~ as.factor(holddf$Trial.x))
summary(mod)
emm <- emmeans(mod, ~ as.factor(Trial.x))
pairs_data <- pairs(emm)
pairs_data
```

### Regraphing Hemi and Carcinus without those who didn't eat (prediction of molt)

```{R, echo=FALSE,results='hide',fig.keep='all'}
summary_df <- EatDF %>%
  group_by(Species.x, Trial.x, Period, still_eating) %>%
  summarise(
    mean = mean(proportion.eaten),
    se = sd(proportion.eaten) / sqrt(n())
  )
summary_df <- subset(summary_df, summary_df$still_eating == "NO")

ggplot(summary_df, aes(x = as.numeric(Trial.x), y = mean, color = Species.x)) + geom_point(position = position_dodge(width = 0.3))+
  scale_color_manual(values = c("HS" = "darkred",
                                 "CM" = "darkgreen",
                                 "CI" = "darkorange"))+
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se),
                width = 0.1, size = 0.8, position = position_dodge(width = 0.3)) +
  geom_smooth(method = "loess", se = FALSE)+ scale_y_log10()+
  ylab("Logged Mean of Proportion Eaten")+
  xlab("Trial Temperature") + labs(color = "Species")+
  ggtitle("Proportion Consumed over Trial Temperature")
```

### Graphing the Husbandry Logs

```{R, echo = FALSE, warning = FALSE}
savedhus <- husbandry
husbandry <- savedhus
husbandry$Date <- as.Date(husbandry$Date, format="%m/%d/%Y")
ggplot(husbandry, aes(x = Date, y = Temperature, color = Trial)) + geom_point() + facet_grid(Period~System)+
  scale_y_continuous(breaks = c(16, 18, 20, 22, 24, 26, 28))+ggtitle("Temperature Records for Each System and Trial") + 
  scale_color_manual(values = c("18"= "yellow",
                               "20" = "#fecc5c",
                               "22" = "#fd8d3c",
                               "24" ="#f03b20",
                               "26" = "#bd0026")) +theme_dark()
```

### Graphing Crab mass before and after the experiment

```{R, echo=FALSE,results='hide',fig.keep='all'}
ID_list <- list()
trial_list <- list()
period_list <- list()
species_list <- list()
weight_before <- list()
weight_after <- list()

for(i in 1:nrow(master)){
  if(master$ID[i] %in% deathMeta$ID){
    
  }
  else{
    ID_list <- append(ID_list, master$ID[i])
    trial_list <- append(trial_list, master$Trial[i])
    period_list <- append(period_list, master$Period[i])
    species_list <- append(species_list, master$Species[i])
    weight_before <- append(weight_before, master$WW[i])
    weight_after <- append(weight_after, checkout$WW[which(checkout$ID == master$ID[i])])
  }
}

weight_df <- data.frame(
  ID = unlist(I(ID_list)),
  Trial = unlist(I(trial_list)),
  Period = unlist(I(period_list)),
  species = unlist(I(species_list)),
  weight_before = unlist(I(weight_before)),
  weight_after = unlist(I(weight_after))
)

weight_df$dif <- as.numeric(weight_df$weight_after) - as.numeric(weight_df$weight_before)

#CM139
#CM141

weight_df <- subset(weight_df, weight_df$ID != "CM139")
weight_df <- subset(weight_df, weight_df$ID != "CM141")

ggplot(weight_df, aes(x = as.factor(species), y = as.numeric(dif), fill = species)) + geom_boxplot(na.rm = TRUE)+
  scale_fill_manual(values = c("Carcinus" = "darkgreen",
                               "Hemigrapsus" = "darkred",
                               "Irroratus" = "darkorange"))+
  geom_hline(yintercept = 0, color = "red", linetype = "dashed", size = 0.5) + ggtitle("Weight change of each species over the whole experiment")+
  facet_wrap(~Trial)+xlab("Species") + ylab("Weight Change (g)")
```
