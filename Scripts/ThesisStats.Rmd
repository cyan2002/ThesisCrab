---
title: "ThesisStats"
author: "ChanceYan"
date: "2025-12-15"
output: html_document
---

```{R, include = FALSE, warning = FALSE}
library(ggplot2)
library(lubridate)
library(hms)
library(dplyr)
library(AICcmodavg)
library(emmeans)
library(multcompView)
setwd("/Users/chanceyan/Documents/R/ThesisCrab/Data")
crabdata <- read.csv("EditFeed.csv", h=T)
death <- read.csv("DeathCount.csv", h=T)
master <- read.csv("Master.csv", h=T)
deathMeta <- read.csv("Death.csv", h=T)
husbandry <- read.csv("Husbandry.csv", h=T)
checkout <- read.csv("CheckOut.csv", h=T)
```

```{R include = FALSE, warning = FALSE}
crabdata$FoodIn <- as.numeric(as.character(crabdata$FoodIn))
crabdata$FoodOut <- as.numeric(as.character(crabdata$FoodOut))

#removing rows that contain no data or recorded incorrectly
for(i in 1:nrow(crabdata)){
  if(!is.numeric(crabdata[i,4])){
    print(crabdata[i])
    crabdata <- crabdata[-i,]
  }
  if(!is.numeric(crabdata[i,6])){
    print(crabdata[i])
    crabdata <- crabdata[-i,]
  }
}



#Creating number IDs for each crab based of their IDs so it's easier to loop through with future code. Also I'm adding a total eaten by proportion column, so we have a standard metric to compare by.
for(i in 1:36){
  master$num[[i]] <- substr(master$ID[[i]], 3,5)
}

crabdata$amount.eaten <- crabdata$FoodIn-crabdata$FoodOut
all <- merge(crabdata, master, by="ID")

#Changing date column into a date data type, so that R can read it as a Date.
all$Date.x = as.Date(all$Date.x, format = "%m/%d/%Y")
deathMeta$Date = as.Date(deathMeta$Date, format = "%m/%d/%Y")

#removing mussel and mackerel feed
all <- subset(all, all$Food != "Mussels")
all <- subset(all, all$Food != "Mackerel")


#saving those who molted in an original dataset
original_molted <- all
original_molted$molted <- ifelse(grepl("ME", original_molted$Notes.x, fixed = TRUE), "YES", "NO")

#Removing those that molted
array <- c()

for(i in 1:nrow(all)){
  if(grepl("ME", all$Notes.x[i], fixed = TRUE)){
    ID_value <- all$ID[i]
    for(j in 1:nrow(all)){
      if(all$ID[j] == ID_value){
        array <- c(array, j)
      }
    }
  }
}

all <- all[-array,]
array <- c()

#Removing these dates because feeding was not following a strict schedule (fed two days back to back)
all <- subset(all, !(WeekNum == 1 & Trial.x == 16))
all <- subset(all, !(WeekNum == 1 & Trial.x == 22 & Period == 1))

#Changing trials 16 and 18 to be one.
original <- all
all$Trial.x <- ifelse(all$Trial.x == "16", "18", all$Trial.x)
original$Trial.x <- ifelse(original$Trial.x == "16", "18", original$Trial.x)
master$Trial <- ifelse(master$Trial == "16", "18", master$Trial)

#Here, I am marking all those who did not eat
EatDF <- subset(all, grepl("DE", all$Notes.x, fixed = TRUE))

#removing all those who ate everything
all <- all[ !grepl("AE", all$Notes.x), ]

#removing all those who were found to have floating food
all <- all[ !grepl("FLOAT", all$Notes.x), ]

#Making a new column indicating whether the animal ate or not
eaten_row <- list()
for(i in 1:nrow(all)){
  if(grepl("DE", all$Notes.x[i], fixed = TRUE)){
    eaten_row <- c(eaten_row, "NO")
  }
  else{
    eaten_row <- c(eaten_row, "YES")
  }
}
all$eaten <- eaten_row

#Making a column if the animal was still eating or not
all$still_eating <- ifelse(grepl("SE", all$Notes.x, fixed = TRUE), "YES", "NO")

inBucket <- list()
#total time of food in bucket
all$TimeInStrip <- as.POSIXct(paste(all$Date.x, all$TimeIn), format = "%Y-%m-%d %I:%M:%S %p")
all$TimeOutStrip <- as.POSIXct(paste(all$Date.x, all$TimeOut), format = "%Y-%m-%d %I:%M:%S %p")

#because we removed the first week from trials 1 and 2, to get the final week, I'll just subtract one from the value to line it up so that week 4 equals week 3 and make it easier for me to graph

all$WeekNum <- ifelse((all$Trial.x == "18" & all$WeekNum == 2 & all$Period == 1), "1", all$WeekNum)
all$WeekNum <- ifelse((all$Trial.x == "18" & all$WeekNum == 3 & all$Period == 1), "2", all$WeekNum)
all$WeekNum <- ifelse((all$Trial.x == "18" & all$WeekNum == 4 & all$Period == 1), "3", all$WeekNum)

all$WeekNum <- ifelse((all$Trial.x == "22" & all$WeekNum == 2 & all$Period == 1), "1", all$WeekNum)
all$WeekNum <- ifelse((all$Trial.x == "22" & all$WeekNum == 3 & all$Period == 1), "2", all$WeekNum)
all$WeekNum <- ifelse((all$Trial.x == "22" & all$WeekNum == 4 & all$Period == 1), "3", all$WeekNum)

#husbandry sheet prep
husbandry <- subset(husbandry, husbandry$Trial != "NONE")
```

BINARY dead or alive (one off - is not affected by removal or replacement of dead crabs)
```{R}
#parsing between those who died during the experiment and those who lived
master$dead <- ifelse(master$ID %in% deathMeta$ID, 0, 1)	

#addition of extras
add_rows <- data.frame(ID = "extra1", System = NA, CL = NA, WW = NA, Trial = "26", Species = "Irroratus", Condition = NA, Period = NA, Date = NA, Notes = NA, num = NA, dead = 0)
master <- rbind(master, add_rows)
add_rows <- data.frame(ID = "extra2", System = NA, CL = NA, WW = NA, Trial = "26", Species = "Irroratus", Condition = NA, Period = NA, Date = NA, Notes = NA, num = NA, dead = 0)
master <- rbind(master, add_rows)
add_rows <- data.frame(ID = "extra3", System = NA, CL = NA, WW = NA, Trial = "24", Species = "Irroratus", Condition = NA, Period = NA, Date = NA, Notes = NA, num = NA, dead = 0)
master <- rbind(master, add_rows)

#model summaries, does not look good
summary(glm(dead ~ 1, family = binomial, data = master))
summary(glm(dead ~ Trial, family = binomial, data = master))
summary(glm(dead ~ Species, family = binomial, data = master))
summary(glm(dead ~ Trial + Species, family = binomial, data = master))
summary(glm(dead ~ Trial*Species, family = binomial, data = master))#(link="logit")

#just looking at cancer irroratus since HS and CM have very little deaths
#dropping trials and species that have 0 deaths gives us something to work with
holddf <- subset(master, master$Species == "Irroratus" & master$Trial != 18)
summary(glm(dead ~ 1, family = binomial, data = holddf))
summary(glm(dead ~ Trial, family = binomial, data = holddf))#(link="logit")
```

RUN THIS FOR 1
DROPPING ALL THOSE WHO DIED AND WERE REPLACED
```{R}
all$proportion.eaten <- all$amount.eaten / all$WW

all <- all[ !is.na(all$ID) & !(all$ID %in% deathMeta$ID), ]
```

RUN THIS FOR 2
KEEPING ALL THOSE WHO DIED (EVERYTHING BEFORE DEATH, AND THE data collected by the REPLACED WITH NEW CRABS)
```{R}
all <- all %>%
  filter(!grepl("ADDI", Notes.x))

all <- all %>%
  filter(!grepl("DI", Notes.x))

#This method accounts for the crabs who died and adds crabs who were replaced after
#run through the feed data
for(i in 1:nrow(all)){
  if(!is.na(all$Date.x[i])){
      #if the individual is marked on the death metasheet then that means they may have been replaced (or not)
    if(any(deathMeta$ID == all$ID[i])){
      #If the ID is on the death metasheet, check which row it's on and see if it's been replaced or not
      row_dat <- deathMeta[deathMeta$ID == all$ID[i],]
      #the value has been replaced!
      if(row_dat$Replaced == "Y"){
        #Only replace if date is after the death date
        if(all$Date.x[i] >= row_dat$Date){
          all$proportion.eaten[i] <- all$amount.eaten[i] / row_dat$ReplacedWeight
          all$WW[i] <- row_dat$ReplacedWeight
        }
        else{
          all$proportion.eaten[i] <- (all$amount.eaten[i] / all$WW[i])
        }
      }
      #If not replaced continue as usual
      else{
        all$proportion.eaten[i] <- (all$amount.eaten[i] / all$WW[i])
      }
    }
    #If not on death sheet continue as usual
    else{
      all$proportion.eaten[i] <- (all$amount.eaten[i] / all$WW[i])
    }
  }
  else{
    all$proportion.eaten[i] <- (all$amount.eaten[i] / all$WW[i])
  }
}
```

KEEP FOR 3
KEEPING ALL THOSE WHO DIED (before death) AND REMOVE THE REPLACED ONES
```{R}
#nothing
all <- all %>%
  filter(!grepl("ADDI", Notes.x))

all <- all %>%
  filter(!grepl("RE", Notes.x))

all <- all %>%
  filter(!grepl("DI", Notes.x))

all$proportion.eaten <- all$amount.eaten / all$WW
```

KEEP FOR 4
DEAD BECOMES 0'S - do not remove "DIs", need to make the actual death (recheck data sheet later), removal of the replaced ones
```{R}
all <- all %>%
  filter(!grepl("RE", Notes.x))

all$proportion.eaten <- all$amount.eaten / all$WW
```


PUSHING THOSE WHO Didn't eat TO 0 (AS OPPOSED TO JUST LEAVING IT) and making values that are negative, 0 or positive
```{R}
#pushing all those who did not eat to 0, rather than keeping them at value
#set to 0.01 rather than 0 for the stats transformation
all$proportion.eaten <- ifelse(grepl("DE", all$Notes.x, fixed = TRUE), 0.01, all$proportion.eaten)
all$proportion.eaten <- ifelse(all$proportion.eaten < 0, 0.01, all$proportion.eaten)
```

DEAD REMOVALS
```{R}
for(i in 1:nrow(all)){
  if(grepl("DI", all$Notes.x[i], fixed = TRUE)){
    all <- all[-i, ] 
  }
  if(is.na(all$amount.eaten[i])){
    all <- all[-i,]
  }
}
```

Acclimation effects
```{R}
summary_df <- all %>%
  group_by(Species.x, Trial.x, Period, WeekNum) %>%
  summarise(
    mean = mean(proportion.eaten),
    se = sd(proportion.eaten) / sqrt(n())
  )

holddf <- subset(summary_df, summary_df$Species.x == "CI")

ggplot(holddf, aes(x = as.numeric(WeekNum), y = mean, color = as.factor(Period))) + 
  geom_point(position = position_dodge(width = 0.2)) + 
  facet_wrap(~Trial.x) +
  ggtitle("Proportion consumed over time for Period 1+2, Rock Crab") + 
  geom_smooth(method = "loess", se = FALSE)+
  scale_color_manual(values = c("1" = "red4","2"="blue4"))+
  xlab("Week Number") + 
  ylab("Amount Eaten (Proportionally)") + 
  labs(color = "Period")+
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), position = position_dodge(width = 0.2))

holddf <- subset(summary_df, summary_df$Species.x == "CM")

ggplot(holddf, aes(x = as.numeric(WeekNum), y = mean, color = as.factor(Period))) + 
  geom_point(position = position_dodge(width = 0.2)) + 
  facet_wrap(~Trial.x) +
  ggtitle("Proportion consumed over time for Period 1+2, Green Crab") + 
  geom_smooth(method = "loess", se = FALSE)+
  scale_color_manual(values = c("1" = "red4","2"="blue4"))+
  xlab("Week Number") + 
  ylab("Amount Eaten (Proportionally)") + 
  labs(color = "Period")+
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), position = position_dodge(width = 0.2))

holddf <- subset(summary_df, summary_df$Species.x == "HS")

ggplot(holddf, aes(x = as.numeric(WeekNum), y = mean, color = as.factor(Period))) + 
  geom_point(position = position_dodge(width = 0.2)) + 
  facet_wrap(~Trial.x) +
  ggtitle("Proportion consumed over time for Period 1+2, Asian Shore Crab") + 
  geom_smooth(method = "loess", se = FALSE)+
  scale_color_manual(values = c("1" = "red4","2"="blue4"))+
  xlab("Week Number") + 
  ylab("Amount Eaten (Proportionally)") + 
  labs(color = "Period")+
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), position = position_dodge(width = 0.2))

holddf <- subset(all, all$Species.x == "CI")
mod <- glm(proportion.eaten ~ as.factor(Trial.x)*as.factor(WeekNum)*as.factor(Period), data = holddf)
summary(mod)


emm <- emmeans(mod, ~ as.factor(Trial.x)*as.factor(WeekNum)*as.factor(Period))

cld_df <- as.data.frame(
  multcomp::cld(emm, Letters = letters, adjust = "tukey")
)

library(ggplot2)

ggplot(cld_df, aes(x = WeekNum, y = emmean, fill = WeekNum)) +
  facet_grid(as.factor(Trial.x)~Period)+
  geom_col(position = position_dodge(width = 0.9)) +
  geom_text(
    aes(label = .group),
    position = position_dodge(width = 0.9),
    vjust = -0.4,
    size = 5
  ) +
  labs(
    x = "Trial",
    y = "Proportion Eaten"
  ) +
  theme_classic() +
  theme(
    legend.position = "top"
  )+
  scale_fill_manual(values = c("1" = "darkorange",
                                "2"="darkgreen",
                                "3"="darkred"))+ coord_cartesian(ylim = c(0, max(cld_df$emmean) * 1.15))

```

ANOVA differences between proportion eaten between species and trial
```{R}
all <- subset(all, all$WeekNum != 1)

mod <- glm(proportion.eaten ~ Trial.x * Species.x, data = all)

emm <- emmeans(mod, ~ Trial.x * Species.x)

cld_df <- as.data.frame(
  multcomp::cld(emm, Letters = letters, adjust = "tukey")
)

ggplot(cld_df, aes(x = Trial.x, y = emmean, fill = Species.x)) +
  geom_col(position = position_dodge(width = 0.9)) +
  geom_text(
    aes(label = .group),
    position = position_dodge(width = 0.9),
    vjust = -0.4,
    size = 5
  ) +
  labs(
    x = "Trial",
    y = "Proportion Eaten"
  ) +
  theme_classic() +
  theme(
    legend.position = "top"
  )+
  scale_fill_manual(values = c("CI" = "darkorange",
                                "CM"="darkgreen",
                                "HS"="darkred"))

# Keep all columns, remove rows with NA in selected columns
all <- all[!is.na(all$proportion.eaten) &
                 !is.na(all$Species.x) &
                 !is.na(all$Trial.x) &
                 !is.na(all$WW), ]


#very Right skewed response variables - try transforming them?
hist(all$proportion.eaten)

#to transform need to set all those who did eat to 0
all$proportion.eaten <- ifelse(grepl("DE", all$Notes.x, fixed = TRUE), 0.01, all$proportion.eaten)
all$proportion.eaten <- ifelse(all$proportion.eaten < 0, 0.01, all$proportion.eaten)
all$prop_log <- log(all$proportion.eaten)

models <- list()
models[[1]] <- glm(proportion.eaten ~ 1, data = all)
models[[2]] <- glm(proportion.eaten ~ Species.x, data = all)
models[[3]] <- glm(proportion.eaten ~ as.factor(Trial.x), data = all)
models[[4]] <- glm(proportion.eaten ~ Species.x + as.factor(Trial.x)+ WW, data = all)
models[[5]] <- glm(proportion.eaten ~ Species.x * as.factor(Trial.x), data = all)
models[[6]] <- glm(proportion.eaten ~ Species.x * as.factor(Trial.x) * WW, data = all)
models[[7]] <- glm(proportion.eaten ~ Species.x * as.factor(Trial.x) + WW, data = all)
models[[8]] <- glm(proportion.eaten ~ Species.x + as.factor(Trial.x) * WW, data = all)
models[[9]] <- glm(proportion.eaten ~ Species.x * WW + as.factor(Trial.x), data = all)

names(models) <- c("null","species","trial","addall","internoweight", "interyesweight", "mixed", "mixed2", "mixed3")
aictab(models)

#best model via AIC
best.mod <- glm(proportion.eaten ~ Species.x * as.factor(Trial.x) * WW, data = all)
plot(best.mod)

#logged models
models <- list()
models[[1]] <- glm(prop_log ~ 1, data = all)
models[[2]] <- glm(prop_log ~ Species.x, data = all)
models[[3]] <- glm(prop_log ~ as.factor(Trial.x), data = all)
models[[4]] <- glm(prop_log ~ Species.x + as.factor(Trial.x)+ WW, data = all)
models[[5]] <- glm(prop_log ~ Species.x * as.factor(Trial.x), data = all)
models[[6]] <- glm(prop_log ~ Species.x * as.factor(Trial.x) * WW, data = all)
models[[7]] <- glm(prop_log ~ Species.x * as.factor(Trial.x) + WW, data = all)
models[[8]] <- glm(prop_log ~ Species.x + as.factor(Trial.x) * WW, data = all)
models[[9]] <- glm(prop_log ~ Species.x * WW + as.factor(Trial.x), data = all)

names(models) <- c("null","species","trial","addall","internoweight", "interyesweight", "mixed", "mixed2", "mixed3")
aictab(models)

hist(all$prop_log)
best.mod <- glm(prop_log ~ Species.x * as.factor(Trial.x) * WW, data = all)
plot(best.mod)
plot(best.mod$residuals)

library(nlme)

library(GGally)

ggpairs(all,columns = c("proportion.eaten", "WW", "Trial.x", "Species.x"))


models <- list()
models[[1]] <- gls(proportion.eaten ~ Species.x * factor(Trial.x) * WW,
             weights = varPower(form = ~fitted(.)),
             data = all,
             na.action = na.omit)
models[[2]] <- gls(proportion.eaten ~ Species.x * factor(Trial.x),
             weights = varPower(form = ~fitted(.)),
             data = all,
             na.action = na.omit)
models[[3]] <- gls(proportion.eaten ~ Species.x * factor(Trial.x) * Period,
             weights = varPower(form = ~fitted(.)),
             data = all,
             na.action = na.omit)
models[[4]] <- gls(proportion.eaten ~ Species.x * factor(Trial.x) + Period,
             weights = varPower(form = ~fitted(.)),
             data = all,
             na.action = na.omit)
models[[5]] <- gls(proportion.eaten ~ 1,
             weights = varPower(form = ~fitted(.)),
             data = all,
             na.action = na.omit)
names(models) <- c("STW","ST", "STP", "STPR", "Null")
aictab(models)

mod <- gls(proportion.eaten ~ Species.x * factor(Trial.x) + Period,
             weights = varPower(form = ~fitted(.)),
             data = all,
             na.action = na.omit)

# Standardized residuals
resid_std <- resid(mod, type = "normalized")  # or "pearson"

# Fitted values
fitted_vals <- fitted(mod)


qqnorm(resid_std)
qqline(resid_std, col = "red")

summary(mod)
```

Time BS
```{R}
#times are NA on this individual
for(i in 1:nrow(all)){
  if(is.na(all$TimeInStrip[i])){
    all <- all[-i,]
  }
}

#all$TimeOut <- hm(all$TimeOut)
for(i in 1:nrow(all)){
  hour <- as.numeric(format(all$TimeInStrip[i], "%H"))
  if(hour < 8){
    #print(all$TimeInStrip[i])
    all$TimeInStrip[i] <- all$TimeInStrip[i] + 12 * 60 * 60
  }
  hour <- as.numeric(format(all$TimeOutStrip[i], "%H"))
  if(hour < 8){
    #print(all$TimeInStrip[i])
    all$TimeOutStrip[i] <- all$TimeOutStrip[i] + 12 * 60 * 60
  }
  
  inBucket <- append(inBucket, as.numeric(difftime(all$TimeOutStrip[i], all$TimeInStrip[i], units = "mins")))
}

all$timeInBucket <- inBucket

all$timebucketnum <- as.numeric(all$timeInBucket)

#to calculate feeding rate based on time in bucket - we need to make amounts more than 0 or 0
all$hours <- all$timebucketnum / 60
all$rate <- all$proportion.eaten / all$hours


```

Things I found:
-Slight changes when switching between the 4 options (nothing signfiicant, graphs look slightly better for some CI)
-for pushing DEs and DIs to 0, there is very little to no change
-For NN2, adding week 2 and 3 into the proportion eaten model does not change much (some letter changes)

Questions:
-If I've added proportion eaten as part of the model (which is based on weight), do I need to add weight as an explanatory variable? When using ggpairs, there is correlation between Wet weight and proportion eaten (expected)
-Do we use GLMs because sometimes there isn't a normal distribution?

